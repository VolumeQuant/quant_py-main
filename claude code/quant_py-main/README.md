# 한국 주식 퀀트 투자 시스템

KOSPI/KOSDAQ 대상 멀티팩터 퀀트 전략 — **Slow In, Fast Out**

---

## 1. 개요

| 항목 | 내용 |
|------|------|
| **전략 철학** | **Slow In, Fast Out** — 3일 검증 후 진입, 50위 이탈 시 즉시 경보 |
| **전략 A** | 마법공식 (Magic Formula) → **사전 필터 200개** (순위 미반영) |
| **전략 B** | 멀티팩터 - Value(45%) + Quality(25%) + Growth(10%) + Momentum(20%, 리스크 조정) → **최종 순위 100%** |
| **MA60 필터** | 현재가 < 60일 이동평균 종목 원천 차단 (가치 함정 방지) |
| **매수 추천** | 3거래일 연속 Top 30 교집합 (가중순위: T0×0.5+T1×0.3+T2×0.2), 전일 -5% 급락 하드 필터, 최대 5종목 |
| **Death List** | Top 50 이탈 종목 즉시 알림 (Fast Out) |
| **유니버스** | 시가총액 3000억+, 거래대금 차등(대형50억↑/중소형20억↑), PER≤60, PBR≤10, 금융/지주사 제외 |
| **시장 경고** | KOSPI/KOSDAQ 이평선 진단 (MA5/MA20/MA60, 데드크로스) → 경고 시 진입 자제 권고 |
| **비중** | 종목당 20% (5종목 × 20% = 100%) |
| **콜드 스타트** | 3거래일 데이터 확보 전까지 채널 전송 스킵 (개인봇에만 전송) |
| **텔레그램** | 매일 06:30 KST 자동 전송 (4메시지: 가이드 → 시장+Top30 → AI 리스크 필터 → 최종 추천), HTML 볼드 |

### 백테스트 성과 (2015-2025)

| 지표 | KOSPI | 전략 A | 전략 B |
|------|-------|--------|--------|
| **CAGR** | 7.58% | **11.98%** | **13.15%** |
| **MDD** | -43.90% | -24.42% | -33.90% |
| **Sharpe** | 0.27 | 0.53 | 0.53 |
| **초과수익** | - | +4.4%p | +5.6%p |

---

## 2. 빠른 시작

### Python 환경

아래 두 경로 중 하나의 Python을 사용:
```
C:\Users\jkw88\miniconda3\envs\volumequant\python.exe
C:\Users\user\miniconda3\envs\volumequant\python.exe
```

### 실행 방법

```bash
# 1. 패키지 설치
pip install pykrx pandas numpy requests beautifulsoup4 lxml pyarrow tqdm scipy html5lib google-genai

# 2. 텔레그램 설정 (선택)
cp config_template.py config.py
# config.py에서 TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID 설정

# 3. 현재 포트폴리오 생성
python create_current_portfolio.py
# - 캐시 모드: ~2분 (컨센서스 수집 포함)
# - 전체 수집: ~5-10분

# 4. 텔레그램 전송
python send_telegram_auto.py

# 5. 전체 백테스팅 (~15분 소요)
python full_backtest.py
```

---

## 3. 프로젝트 구조

```
quant_py-main/
│
├── [핵심 모듈] ─────────────────────────────────────────────
│   ├── error_handler.py          # Skip & Log 에러 처리
│   ├── fnguide_crawler.py        # FnGuide 재무제표 캐시 + 가중TTM
│   ├── data_collector.py         # pykrx API + 병렬 처리
│   ├── strategy_a_magic.py       # 전략 A: 마법공식 (사전 필터)
│   ├── strategy_b_multifactor.py # 전략 B: 멀티팩터 (리스크 조정 모멘텀)
│   ├── ranking_manager.py        # 일일 순위 저장/3일 교집합/Death List
│   └── gemini_analysis.py        # Gemini AI 리스크 필터 + 최종 추천 멘트
│
├── [실행 스크립트] ─────────────────────────────────────────
│   ├── create_current_portfolio.py  # 포트폴리오 생성 + 순위 JSON 저장
│   ├── send_telegram_auto.py        # 텔레그램 4메시지 전송 (가이드→시장→AI→최종)
│   ├── full_backtest.py             # 전체 백테스팅
│   └── generate_report_pdf.py       # PDF 리포트 생성
│
├── [설정] ──────────────────────────────────────────────────
│   ├── config.py                # API키/텔레그램 설정 (gitignore)
│   └── config_template.py       # 설정 템플릿
│
├── [상태 저장] ─────────────────────────────────────────────
│   └── state/                   # 일일 순위 JSON (GitHub Actions가 git commit)
│       └── ranking_YYYYMMDD.json
│
├── [출력 디렉토리] ─────────────────────────────────────────
│   ├── output/                  # 포트폴리오 CSV/리포트
│   └── backtest_results/        # 백테스트 결과
│
├── [캐시] ──────────────────────────────────────────────────
│   └── data_cache/              # 재무제표/OHLCV parquet 캐시
│
└── [문서] ──────────────────────────────────────────────────
    ├── README.md                # 프로젝트 개요 (이 파일)
    └── SESSION_HANDOFF.md       # 개발 히스토리/기술 문서
```

---

## 4. 핵심 모듈 상세

### 4.1 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                        데이터 수집                               │
├─────────────────────────────────────────────────────────────────┤
│  pykrx API                          FnGuide                     │
│  ┌─────────────┐               ┌──────────────┐                │
│  │ 시가총액    │               │ 재무제표     │                │
│  │ OHLCV      │               │ (캐시)       │                │
│  │ PER/PBR/DIV│               │              │                │
│  └──────┬──────┘               └──────┬───────┘                │
│         └──────────────┬──────────────┘                        │
│                        ▼                                        │
│                 ┌─────────────┐                                 │
│                 │  유니버스   │                                 │
│                 │ 시총3000억+ │                                 │
│                 │ 거래 차등   │                                 │
│                 │ PER≤60     │                                 │
│                 │ PBR≤10     │                                 │
│                 └──────┬──────┘                                 │
└────────────────────────┼────────────────────────────────────────┘
                         │
┌────────────────────────┼────────────────────────────────────────┐
│                        │     전략 실행                           │
├────────────────────────┼────────────────────────────────────────┤
│                        ▼                                        │
│              ┌─────────────────┐                                │
│              │  MA60 추세 필터  │                                │
│              │ 현재가 < MA60   │                                │
│              │   → 제외        │                                │
│              └────────┬────────┘                                │
│                       ▼                                         │
│              ┌─────────────────┐                                │
│              │   전략 A 사전필터 │                               │
│              │   (마법공식)     │                                │
│              │   상위 200종목   │                                │
│              └────────┬────────┘                                │
│                       ▼                                         │
│              ┌─────────────────┐                                │
│              │  전략 B 스코어링 │                                │
│              │  (멀티팩터)      │                                │
│              │ 리스크조정모멘텀 │                                │
│              └────────┬────────┘                                │
│                       ▼                                         │
│              ┌─────────────────┐                                │
│              │ 멀티팩터 100%   │                                │
│              │ 순위 JSON 저장  │                                │
│              └────────┬────────┘                                │
│                       ▼                                         │
│              ┌─────────────────┐                                │
│              │ 3일 교집합 검증  │                                │
│              │ Death List 계산 │                                │
│              │ Survivors Top50 │                                │
│              └─────────────────┘                                │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 전략 A - 마법공식 (사전 필터)

```
이익수익률 = EBIT / EV      (EV = 시가총액 + 총부채 - 여유자금)
투하자본수익률 = EBIT / IC   (IC = (유동자산 - 유동부채) + 비유동자산)

마법공식_순위 = rank(이익수익률) + rank(ROIC)
→ 상위 200종목 사전 필터 (순위 반영 없이 스크리닝만)
```

### 4.3 전략 B - 멀티팩터 (최종 스코어링)

```
Value    45%: PER(실시간) + PBR(실시간) + PCR + PSR + DIV(실시간)
Quality  25%: ROE + GPA + CFO/Assets
Growth   10%: EPS개선도(Forward PER 기반) + 매출성장률(YoY, 연간 매출액 2개년 비교)
Momentum 20%: (12M수익률 - 1M수익률) / 12M변동성(연환산) [리스크 조정]

멀티팩터_점수 = Value*0.45 + Quality*0.25 + Growth*0.10 + Momentum*0.20

모멘텀 공식 (v6.0):
  Score = (12M수익률 - 1M수익률) / 12M변동성(연환산, floor 15%)
  - 12M수익률 ≤ 0 → 제외 (하락 추세)
  - 변동성 하한선 15% (저변동 종목 점수 폭발 방지)

EPS개선도 = (Trailing PER - Forward PER) / Trailing PER * 100
  양수 = 실적 개선 중, 음수 = 실적 악화 중
  Forward PER: FnGuide 컨센서스 (커버리지 ~80%)

매출성장률(YoY) = (최근매출액 - 전기매출액) / |전기매출액| × 100
  FnGuide 연간 재무제표 2개년 비교 (90일 공시 시차 적용)
  커버리지: ~97% (557/574개)
```

### 4.4 가중 TTM (Weighted Trailing Twelve Months)

```
손익계산서/현금흐름표 항목:
  최신 분기: 40% (가중치 1.6)
  2번째 분기: 30% (가중치 1.2)
  3번째 분기: 20% (가중치 0.8)
  4번째 분기: 10% (가중치 0.4)
  합계 = 4.0 (기존 TTM 합산과 동일 스케일)
→ 최근 실적 변화를 더 잘 반영
```

### 4.5 MA60 추세 필터

```
현재가 >= 60일 이동평균 → 통과
현재가 <  60일 이동평균 → 제외 (가치 함정 원천 차단)

→ 아무리 저평가라도 중기 하락 추세면 진입하지 않음
```

### 4.6 3일 교집합 (Slow In)

```
일일 순위를 state/ranking_YYYYMMDD.json에 저장
3거래일(T-0, T-1, T-2) 연속 Top 30에 있는 종목만 매수 추천

가중 평균 순위: T-0 × 0.5 + T-1 × 0.3 + T-2 × 0.2
→ 가중순위 낮은 순서대로 최대 5종목
→ 전일 -5% 급락 종목은 하드 필터로 제외 (다음 순위로 대체)
→ 0개면 "관망" (무리한 진입 방지)
→ 콜드 스타트: 순위 데이터 3일 미만이면 관망

종목당 비중: 20% (5종목 × 20% = 100%)
```

### 4.6a Death List (Fast Out)

```
어제(T-1) Top 50에 있었으나 오늘(T-0) 51위 밖으로 이탈한 종목
→ 전체 탈락자 목록 표시 (cap 없음)
→ 보유 종목이 있으면 매도 검토 권장
```

### 4.7 시장 이평선 경고

```
KOSPI/KOSDAQ 지수의 이동평균선 상태를 자동 진단
120일 데이터로 MA5, MA20, MA60 계산

감지 신호:
  - 5일선↓: 현재가 < MA5 (단기 조정)
  - 20일선↓: 현재가 < MA20 (중기 하락)
  - 60일선↓: 현재가 < MA60 (장기 하락)
  - 단기DC: MA5 < MA20 (데드크로스)

경고 수준:
  ⚡ 주의: 1개 신호
  ⚠️ 경계: 2개 신호
  🚨 위험: 3개+ 신호

→ 경고 시 "신규 매수 시 유의하세요" 문구 표시
→ 양호 시 경고 블록 생략 (깔끔한 헤더 유지)
```

### 4.8 텔레그램 메시지 (v8.1 — 4메시지)

```
메시지 흐름: 📖 가이드 → [1/3] 시장 → [2/3] AI → [3/3] 최종

📖 투자 가이드
  - 5단계 선정 과정 (①~⑤)
  - 보유/매도 기준
  - [1/3] [2/3] [3/3] 메시지 안내

[1/3] 📊 시장 + Top 30 — parse_mode='HTML'
  - 날짜 + 코스피/코스닥 각각 별도 줄 (개별 색상)
  - 이평선 경고 블록 (있을 때만 표시)
  - 읽는 법 (✅ 3일 검증 / ⏳ 내일 검증 / 🆕 신규 진입)
  - Top 30 상태별 그룹핑 + 순위 궤적 표시
    - ✅ 3일 검증: 가중순위 순 정렬 + 3일 궤적 (1→1→1)
    - ⏳ 내일 검증: 2일 궤적 (8→14)
    - 🆕 신규 진입: 당일 순위만
  - 📉 이탈 종목 순위 변동 (어제 18위 → 현재 35위 / 순위권 밖) + 매도 검토
  - "👉 다음: AI 리스크 필터 [2/3]"

[2/3] 🛡️ AI 리스크 필터 — parse_mode='HTML'
  - Gemini 2.5 Flash + Google Search Grounding
  - 📰 시장 동향 (검색 기반)
  - ⚠️ 매수 주의 종목 (코드가 계산한 위험 플래그 기반)
  - ✅ 위험 신호 없음 (코드 직접 생성)
  - "👉 다음: 최종 추천 [3/3]"

[3/3] 🎯 최종 추천 — parse_mode='HTML'
  - 퍼널 경로 (598종목 → Top 30 → ✅ 검증 → 최종 N종목)
  - ⚠️ 급락 제외 종목 안내 (전일 -5% 하드 필터)
  - 📊 비중 한눈에 보기 (원라인 요약)
  - 종목별 AI 멘트 (Gemini 생성, 날씨아이콘 + 순위 궤적 + 1-2줄 선정 이유)
  - 구분선으로 종목 분리
  - 💡 활용법 + 면책 문구
  - AI 실패 시 코드 기반 rationale fallback

콜드 스타트 (3일 미확보):
  - [2/3] [3/3] 생략, 가이드 + [시장+Top30]만 전송
  - 채널 전송 스킵, 개인봇에만 전송
```

### 4.9 AI 분석 (Gemini) — 2단계

```
"검색은 코드가, 분석은 AI가" 원칙

[1단계] AI 리스크 필터 (run_ai_analysis)
→ 매수 후보 종목의 위험 신호를 코드가 계산, AI가 해석
→ Gemini 2.5 Flash + Google Search Grounding
→ 시장 동향 검색(1회) + 위험 신호 해석
→ 플래그에 걸려도 최종 추천에서 빠지지 않음 (경고만)

위험 플래그 4개 (모델이 못 잡는 당일 이벤트만):
  🔺 RSI ≥ 80 (극단적 과열) — 경고만
  ⚠️ 전일 -5% 이상 급락 (악재 확인) — **하드 필터 (최종 추천에서 제외)**
  🔺 전일 +8% 이상 급등 (추격매수 위험) — 경고만
  📊 거래량 평소 3배 이상 (비정상 움직임) — 경고만

제거된 플래그 (모델과 충돌):
  52주 -35% 급락 → "싸게 사자" 철학과 충돌 + MA60이 가치함정 차단
  PER > 40 → Value 50% + 유니버스 PER≤60과 중복

[2단계] 최종 추천 AI 멘트 (run_final_picks_analysis)
→ 종목별 1-2줄 선정 이유를 AI가 자연어로 작성
→ 날씨아이콘 (🔥/☀️/🌤️/⛅) + 순위 궤적 (순위 X→Y→Z) + 선정 이유
→ Gemini 2.5 Flash (검색 없음, temperature=0.2)
→ 500자 이내, [SEP] 구분자 → 코드가 구분선으로 치환
```

---

## 5. 설정 파일

### config.py (gitignore)

```python
TELEGRAM_BOT_TOKEN = "your_bot_token"
TELEGRAM_CHAT_ID = "your_chat_id"
TELEGRAM_PRIVATE_ID = "your_private_id"
MIN_MARKET_CAP = 3000
PER_MAX_LIMIT = 60
PBR_MAX_LIMIT = 10
MAX_CONCURRENT_REQUESTS = 10
PYKRX_WORKERS = 10
PREFILTER_N = 200
N_STOCKS = 30
GEMINI_API_KEY = "your_gemini_api_key"
```

---

## 6. GitHub Actions 자동화

### 매일 06:30 KST 자동 실행

```yaml
# .github/workflows/telegram_daily.yml
on:
  schedule:
    - cron: '30 21 * * 0-4'  # UTC 21:30 = KST 06:30 (월~금)
  workflow_dispatch:           # 수동 실행 가능
permissions:
  contents: write              # state/ 디렉토리 git commit용
```

### 실행 흐름

```
1. checkout → 최신 코드 + state/ 순위 파일 pull
2. Python 3.11 설치 + pip install
3. config.py 생성 (GitHub Secrets)
4. create_current_portfolio.py → 순위 스코어링 + state/ranking_YYYYMMDD.json 저장
5. send_telegram_auto.py → 3일 교집합 + Death List + Survivors 전송 + AI 브리핑
6. git commit + push → state/ 디렉토리 (순위 JSON 영속화)
```

### GitHub Secrets

Repository → Settings → Secrets → Actions:
- `TELEGRAM_BOT_TOKEN`: 봇 토큰
- `TELEGRAM_CHAT_ID`: 채널 ID
- `TELEGRAM_PRIVATE_ID`: 개인 채팅 ID
- `GEMINI_API_KEY`: Gemini API 키 (AI 리스크 분석용)

---

## 7. 주의사항

1. **캐시 활용**: 재수집 불필요 시 캐시 모드 사용 권장
2. **FnGuide 캐시**: 매주 일요일 03:00 KST 자동 갱신 (`fnguide_weekly.yml`)
3. **백테스트 한계**:
   - 생존 편향 (상장폐지 종목 미포함)
   - 거래비용 단순화 (0.3% 고정)
   - 슬리피지 미반영

---

*버전: 8.3 Slow In, Fast Out | 최종 업데이트: 2026-02-12 | Generated by Claude Code*
