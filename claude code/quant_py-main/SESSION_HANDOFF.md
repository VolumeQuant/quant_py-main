# 한국 주식 퀀트 포트폴리오 시스템 - 기술 문서

## 문서 개요

**버전**: 20.6
**최종 업데이트**: 2026-02-24
**작성자**: Claude Opus 4.6

---

## 핵심 변경사항 (v20.6 — OHLCV 증분 수정 + 태그 제거 + 급락 플래그 제거)

### 2026-02-24

**배경 1**: OHLCV 증분 업데이트 API 버그 — ranking JSON의 `price` 필드에 stale 가격 저장.
- `create_current_portfolio.py`의 증분 업데이트가 `get_market_ohlcv_by_date(date_str, market='ALL')` 호출
- 올바른 함수는 `get_market_ohlcv_by_ticker(date_str, market='ALL')` (전종목 하루치 데이터)
- `by_date`는 per-ticker 함수(fromdate, todate, ticker 시그니처) → TypeError → `except Exception: pass`로 무시
- 결과: 갭 ≤10일일 때 증분 실패 → stale cache 가격 사용 → 테스 0220 가격이 66,200(0212 가격)으로 기록
- 갭 >10일이면 전체 재수집하므로 정상 작동 → 간헐적 버그

**배경 2**: 팩터 변화 태그(가치↓ 품질↑ 등)가 노이즈 > 정보.
- 일간 팩터 등수 변화는 다른 종목의 상대 이동이 원인인 경우가 대부분
- 핵심 정보는 순위 변화(29→38위)와 이탈 여부로 충분
- ranking JSON price 버그로 전망/가격 태그 신뢰도도 낮았음

**배경 3**: 전일 급락(-5%) 리스크 플래그가 전략 철학과 모순.
- 4겹 검증(유니버스→MA120→멀티팩터→3일교집합) 통과 종목의 급락은 매수 기회
- 테스(5위)가 -5.83% 급락으로 flagged → 삼성전자(6위, clean)에 밀려 TOP 5에서 탈락
- 사용자에게 테스 탈락 이유가 표시되지 않아 혼란 유발

**수정**:
| 파일 | 변경 |
|------|------|
| `create_current_portfolio.py` | `get_market_ohlcv_by_date` → `get_market_ohlcv_by_ticker` (증분 API 수정) |
| `test_new_telegram.py` | `compute_factor_tags()`, `_filter_neg_tags()` 함수 삭제, 태그 표시 3곳 제거, `factor_ranks_t1`/`t2` 계산 제거 |
| `gemini_analysis.py` | `compute_risk_flags()`에서 `daily_chg <= -5` 급락 플래그 제거 |

**효과**:
- OHLCV 증분 업데이트 정상 작동 → ranking JSON price 정확
- 메시지에서 팩터 태그 노이즈 제거 → 깔끔한 순위 표시
- 급락 종목도 순위 그대로 TOP 5 선정 → 테스(5위) 정상 진입

---

## 핵심 변경사항 (v20.5 — 가중순위 통일 + 급락 필터 제거)

### 2026-02-23

**배경 1**: 표시 순위와 판정 기준 불일치 — composite_rank(순수 점수 순위)로 표시하면서 rank(가중순위)로 Top 30 판정.
- 신세계: composite_rank=29(표시)인데 rank=31(판정) → "29위인데 왜 이탈?" 혼란
- Top 30 = 3일 가중순위 기반 → 표시도 가중순위여야 일관적

**배경 2**: -5% 급락 하드 필터가 전략 철학과 모순.
- "좋은 회사를 싸게 살 수 있는 타이밍"인데, 좋은 회사가 싸지면 제외
- 씨에스윈드: 3일 연속 Top 7인데 -5.2% 급락 → 기회를 걷어참
- MA120 필터 + 모멘텀 팩터 + Death List + AI 리스크가 이미 안전장치

**배경 3**: Top 5 추천이 별도의 3일 교집합 가중순위(composite_rank 기반)를 사용 → Top 30의 rank와 이중 계산.

**수정**:
| 파일 | 변경 |
|------|------|
| `send_telegram_auto.py` | 모든 표시를 rank(가중순위)로 통일, ✅ 검증 종목 rank 순 Top 5, -5% 하드필터 제거→정보 표시 |

**세부 변경**:
1. `format_top30()`: composite_rank → rank 전면 교체 (✅/⏳/🆕/📉이탈 모든 섹션)
2. Top 5 추천: `compute_3day_intersection` → pipeline ✅ 검증 종목에서 rank 순 상위 5개
3. -5% 하드 필터 제거: `skipped` → `drop_info`, 종목 설명에 "📉 전일 -X.X% (참고)" 정보만 표시
4. AI에 전달하는 rank도 가중순위 사용

**효과**:
- 신세계: "28위→29위 이탈" → "28위→31위 이탈" (판정 사유 명확)
- 씨에스윈드: 제외 → 추천 후보 유지 (AI 리스크에서 급락 정보 제공)
- 표시·판정·추천 모두 rank(가중순위) 기준으로 통일

---

## 핵심 변경사항 (v20.4 — 시스템 레벨 매도)

### 2026-02-21

**배경**: 시장 위험 지표(credit_monitor)가 "매도하세요"라고 안내해도 [3/3] 최종 추천에서 Top 5를 그대로 보여줌.
- 말과 행동이 불일치 — "매도" 메시지 옆에 5종목 추천은 모순
- Death List는 종목 레벨 매도(30위 이탈), 시스템 레벨 매도는 없었음

**해결**: `final_action` 키워드 기반으로 추천 종목 수(max_picks)를 자동 조절

| 키워드 | max_picks | 의미 |
|--------|-----------|------|
| "즉시 매도" | 0 | 전량 매도 |
| "매도하세요" | 0 | 매도 |
| "멈추" | 0 | 매수 중단 |
| "관망" | 0 | 관망 |
| "줄이" | 3 | 축소 (33%씩) |
| "분할 매수" | 3 | 분할 매수 |
| "신중" | 5 | 정상 + 경고 |
| 기본값 | 5 | 정상 |

**수정 파일**:
| 파일 | 변경 |
|------|------|
| `credit_monitor.py` | `get_market_pick_level(credit_status)` 함수 추가 |
| `send_telegram_auto.py` | import + pick_level 로직 + market_max_picks 적용 + [3/3] 대체 메시지 |

**max_picks == 0일 때**: AI 분석 스킵, [3/3]에 매수 중단 메시지 표시
**현재 테스트**: ☀️여름(평소대로) → 정상(5종목) 출력 예상

---

## 핵심 변경사항 (v20.3 — 태그 방향 필터 제거)

### 2026-02-21

**배경**: 방향 필터(순위 상승→긍정태그만, 순위 하락→부정태그만)가 태그를 과도하게 억제.
- 24개 ✅ 종목 중 태그가 1개뿐 (감성코퍼레이션만)
- 불장에서 순위 상승 종목 대부분 가격도 상승 → 📈가격↑ 태그가 방향 불일치로 숨겨짐
- 대부분의 순위 변동은 다른 종목의 상대 이동이 원인 → "왜 변했나"보다 "무슨 일이 있었나"가 유용

**수정**: `ranking_manager.py` — `compute_rank_driver()`
- 방향 필터 제거: EPS/가격 변화를 있는 그대로 표시
- `_compute_exit_reason`(Death List)은 원래 방향 필터 없었으므로 변경 없음

**효과**: ✅ 섹션 태그 1개 → 4개
- 유바이오로직스(📈가격↑), 현대홈쇼핑(⚠️전망↓), 감성코퍼레이션(💪전망↑ 📈가격↑), 나무가(📈가격↑)
- 현대홈쇼핑: 순위는 올랐지만 EPS 전망 하향 경고 — 방향 필터였으면 숨겨졌을 정보

---

## 핵심 변경사항 (v20.2 — ±3 클리핑 제거, 재정규화만 유지)

### 2026-02-21

**배경**: v20.0에서 재정규화(std=1) + ±3 클리핑을 동시 적용했으나, 클리핑이 ceiling effect를 유발.
- 모멘텀 z-score가 4~5인 종목들(SK하이닉스, SK스퀘어, 브이엠)이 모두 3.0으로 잘림
- 동일 점수 → 동일 순위 → 매일 같은 Top 5 → 3일 교집합이 의미 없어짐
- 재정규화만으로도 분산 통일(std=1) 달성 → 클리핑은 불필요하고 유해

**수정**: `strategy_b_multifactor.py`
- ±3 클리핑 코드 제거 (`data[col] = data[col].clip(-3.0, 3.0)` 삭제)
- 재정규화만 유지 (`(data[col] - mean) / std`)
- V25/Q25/G25/M25 균등 비중 유지

**효과**:
- 극단 모멘텀 종목들 간 점수 차이가 살아남 (3.0/3.0/3.0 → 4.8/3.9/3.5)
- 매일 다른 순위 → 3일 교집합이 실질적 필터로 작동
- 불장에서 성장/모멘텀 종목 적절히 포착

---

## 핵심 변경사항 (v20.1 — 이진 분류 태그: 전망 vs 가격)

### 2026-02-21

**배경**: 기존 순위 태그(V/Q/M 팩터 점수 기반)에 3가지 문제:
1. 재정규화된 상대 점수로 절대 가격 방향 추론 불가 (삼성전자 7%↑인데 📉가격↓ 표시)
2. V↓/M↓이 같은 현상(가격 변동)의 양면이라 구분 무의미
3. quality_s가 다른 종목 움직임에 영향받아 거짓 경보 발생

**해결**: 두 축을 독립적으로 판단하는 이진 분류

| 축 | 데이터 소스 | 태그 | threshold |
|-----|------------|------|-----------|
| **전망** | Forward EPS = price/fwd_per (컨센서스) | 💪전망↑ / ⚠️전망↓ | 3% |
| **가격** | 실제 종가 비교 | 📈가격↑ / 📉가격↓ | 3% |

**수정 파일**:
| 파일 | 변경 |
|------|------|
| `ranking_manager.py` | `compute_rank_driver` + `_compute_exit_reason` → Forward EPS + 실제 주가 기반 |
| `create_current_portfolio.py` | 순위 JSON에 `price` 필드(종가) 추가 |
| `send_telegram_auto.py` | 태그 괄호 표시 `9위(💪전망↑ 📈가격↑)` + 가이드 범례 제거 |
| state/*.json | 7개 파일 전체 pykrx로 종가 소급 적용 |

**표시 형식**: `삼성전자 6→8→9위(💪전망↑ 📈가격↑)`

---

## 핵심 변경사항 (v20.0 — 카테고리 재정규화 + 균등 비중)

### 2026-02-21

**배경**: v19.7 클리핑만으로는 부족. 하위지표 개수 차이(V:5개→평균→분산↓, M:1개→분산 그대로)로 인해 모멘텀이 여전히 68% 실질 기여. hyunyulhenry 방식(이중 Z-Score) 참고.

**수정**: `strategy_b_multifactor.py`
1. 클리핑 → **재정규화**(mean=0, std=1)로 전환 (v20.2에서 ±3 클리핑 제거)
2. V45/Q15/G10/M30 → **V25/Q25/G25/M25** 균등 비중

```python
# 재정규화: 카테고리별 std를 1로 통일
for col in ['밸류_점수', '퀄리티_점수', '성장_점수', '모멘텀_점수']:
    if col in data.columns and data[col].std() > 0:
        data[col] = (data[col] - data[col].mean()) / data[col].std()

# 균등 비중
data['멀티팩터_점수'] = (data['밸류_점수'] * 0.25 +
                        data['퀄리티_점수'] * 0.25 +
                        data['성장_점수'] * 0.25 +
                        data['모멘텀_점수'] * 0.25)
```

**효과**:
- 모멘텀 실질 기여: 68% → **28%**
- Quality/Growth가 살아남: Q=36%, G=35%
- Top 10에 씨에스윈드, 제룡전기 등 Growth+Quality 종목 신규 진입
- 전체 state/ JSON 재정규화 + 균등비중 재계산

**pykrx 버전 핀**: 3개 워크플로우 전부 `pykrx==1.2.3` 고정 (최신 버전 컬럼명 변경으로 크래시)

---

## 핵심 변경사항 (v19.7 — 카테고리 점수 ±3 클리핑)

### 2026-02-21

**배경**: 5일 실데이터 분석 결과, 모멘텀 z-score 극단값(4~5σ)으로 V45/Q15/G10/M30 비중이 무의미해지는 문제 발견.
- Top 10 중 9개가 모멘텀 주도 (매일 동일)
- SK스퀘어(1위): 모멘텀 제거 시 156위 (value_s = -1.73)
- 모멘텀 명목 비중 30% → 실질 기여 ~58%

**원인**: 카테고리 점수 범위 불균형
- 밸류_점수: ±2 (5개 z-score 평균 → 분산 감소)
- 퀄리티_점수: ±2 (3개 z-score 평균)
- 성장_점수: ±2.5 (2개 z-score 평균)
- 모멘텀_점수: ±5 (z-score 1개, 평균화 없음 → 극단값)

**수정**: `strategy_b_multifactor.py` line 335~341

```python
ZSCORE_CAP = 3.0
for col in ['밸류_점수', '퀄리티_점수', '성장_점수', '모멘텀_점수']:
    if col in data.columns:
        clipped = (data[col] > ZSCORE_CAP).sum() + (data[col] < -ZSCORE_CAP).sum()
        if clipped > 0:
            print(f"  {col}: {clipped}개 종목 클리핑 (±{ZSCORE_CAP})")
        data[col] = data[col].clip(-ZSCORE_CAP, ZSCORE_CAP)
```

**효과**: 모든 카테고리 점수 범위가 ±3으로 통일 → V45/Q15/G10/M30 비중이 실제 기여도를 정확히 반영.

**비중 변경 없음**: 클리핑 효과를 먼저 확인 후 필요시 조정 (변수 1개만 변경 원칙).

**README.md 비중 정정**: 문서에 Q25/M20으로 잘못 기재 → Q15/M30으로 정정 (코드 실제와 일치).

---

## 핵심 변경사항 (v19.6 — 순위 태그 종합 개선)

### 2026-02-21

**배경**: 7일치 데이터(467~642쌍) 분석으로 threshold 재조정. 사용자 피드백: "진짜 주목할 정보만 표기", 💡저평가↑ 과다, 🔄상대변동 무의미.

| 개선 | 내용 |
|------|------|
| **|변동| < 3 필터** | 1~2칸 변동은 노이즈 → 태그 생략 (US 프로젝트 동일) |
| **🔄상대변동 제거** | 원인 불명 시 태그 자체 없음 (깔끔) |
| **Threshold 재조정** | 7일 데이터 기반, ~25% 초과율 목표 |
| **Death List 통일** | 구 `[V↓ Q↓]` 복수태그 → `compute_rank_driver` 단일태그 |
| **AI 프롬프트 태그** | `gemini_analysis.py`에 driver 태그 전달 → 맥락 있는 AI 멘트 |

#### Threshold (7일 데이터, ~25% 초과율)

| 팩터 | ⏳ 1일 | ✅ 2일 | 근거 |
|------|--------|--------|------|
| V | 0.06 | 0.08 | V/M은 √t 스케일링 |
| Q | 0.06 | 0.06 | 분기 재무 → 시간 무관 |
| M | 0.10 | 0.15 | 가장 변동성 큰 팩터 |

---

## 핵심 변경사항 (v19.5 — 순위 태그 방향 일치 로직)

### 2026-02-21

**배경**: v19.4에서 비교 구간을 T-0 vs T-2로 수정했으나, 태그 방향과 순위 방향이 불일치하는 문제 발견.
- 삼성전자 6→10→7 (순위 하락) → 💪실적↑ 표시 (Q delta +0.047이 threshold 0.04를 턱걸이로 넘어 우선 적용)
- LG유플러스 9→9→8 (순위 개선) → 📉모멘텀↓ 표시 (M delta -0.226이 V delta +0.065보다 커서 선택)
- 원인: Q 우선순위 + 방향 무시 로직

**수정**: Q 우선순위 제거, 순위 방향에 맞는 delta만 필터링 → 절대값 최대 팩터 선택

| 파일 | 변경 |
|------|------|
| `ranking_manager.py` | `compute_rank_driver(t0, t_ref, rank_improved)` — 방향 필터 + 절대값 최대 |
| `send_telegram_auto.py:274` | ✅: `rank_improved=(r0 < r2)` 전달 |
| `send_telegram_auto.py:302` | ⏳: `rank_improved=(r0 < r1)` 전달 |

**검증 (삼성전자 6→7)**:
- 음(-) delta: M=-0.271 (최대) → **📉모멘텀↓** ✅
- 양(+) delta: Q=+0.047, V=+0.068 → 무시 (순위 하락 방향 아님)

**검증 (LG유플러스 9→8)**:
- 양(+) delta: V=+0.065 (최대) → **💡저평가↑** ✅
- 음(-) delta: M=-0.226 → 무시 (순위 개선 방향 아님)

---

## 핵심 변경사항 (v19.4 — 순위 태그 비교 구간 수정)

### 2026-02-21

**배경**: v19.3에서 순위 태그를 추가했으나, 실데이터 검증 결과 대부분 🔄상대변동으로 표시. 원인: ✅ 3일 궤적을 보여주면서 T-0 vs T-1 (1일) 만 비교하면 delta가 threshold를 못 넘음.

**검증 데이터** (지엔씨에너지 8→5→4위):
- value_s T0-T1: +0.041 < threshold 0.05 → 🔄상대변동 (놓침)
- value_s T0-T2: +0.074 > threshold 0.05 → 💡저평가↑ (정확한 진단)

| 파일 | 변경 내용 |
|------|----------|
| `send_telegram_auto.py:274` | ✅ 3일 검증: `compute_rank_driver(s, t1_item)` → `compute_rank_driver(s, t2_item)` |

**규칙**: 궤적 표시 기간 = 비교 구간
- ✅ 3일 검증 (T-2→T-1→T0): T-0 vs T-2 비교
- ⏳ 2일 검증 (T-1→T0): T-0 vs T-1 비교 (변경 없음)

---

## 핵심 변경사항 (v19.3 — 순위 변동 사유 태그)

### 2026-02-21

**배경**: 사용자가 "순위가 올라간/떨어진 이유를 알고 싶다"고 요청. 예: "가치는 좋은데 가격반영이 되고 있어서 떨어지는거면 보유 종목이면 안심해도 된다." US 프로젝트(eps-momentum-us)와 동일한 태그 스타일로 통일.

| 파일 | 변경 내용 |
|------|----------|
| `ranking_manager.py` | `compute_rank_driver(t0, t1)` 함수 추가 — V/Q/M 팩터 delta 비교, 태그 1개 반환 |
| `send_telegram_auto.py` | `t1_full`/`t2_full` 맵 (팩터 접근), ✅/⏳ 궤적에 driver 태그 부착 |
| `README.md` | v9.3 + 순위 변동 태그 섹션 (4.6a) 추가 |

#### 태그 7종 (US 스타일 통일)

| 태그 | 조건 | 투자 시사점 |
|------|------|------------|
| ⚠️실적↓ | Q↓ (threshold 0.04) | 매도 검토 |
| 💪실적↑ | Q↑ (threshold 0.04) | 긍정적 |
| 📈주가↑ | V↓ 주도 (threshold 0.05) | 보유 OK |
| 💡저평가↑ | V↑ 주도 (threshold 0.05) | 매수 기회 |
| 📈모멘텀↑ | M↑ 주도 (threshold 0.10) | 추세 탑승 |
| 📉모멘텀↓ | M↓ 주도 (threshold 0.10) | 관망 |
| 🔄상대변동 | delta 미미 | 상대적 변동 |

#### 판단 로직
```
Q 우선 → V/M 중 |delta| 큰 쪽 → 🔄상대변동 fallback
순위 변화 없으면 태그 없음
```

---

## 핵심 변경사항 (v19.2 — 순위 표시 일관성 종합 수정)

### 2026-02-21

**배경**: 사용자가 실제 투자에 사용 중, 02/19 브이엠 5위 → 02/20 어제 8위로 표시되는 불일치 발견. 원인 분석 결과 6건의 버그 확인. 종합 감사 실시.

| # | 심각도 | 파일 | 문제 | 수정 |
|---|--------|------|------|------|
| 1 | CRITICAL | `send_telegram_auto.py:274` | 궤적 역순 표시 (T0→T-1→T-2) | T-2→T-1→T0 시간순으로 수정 |
| 2 | CRITICAL | `send_telegram_auto.py:258` | 이전일 Top30 밖 종목 궤적 누락 (`rank<=30` 필터) | 필터 제거, 전체 종목 맵 |
| 3 | HIGH | `send_telegram_auto.py:305` | Death List에서 `rank`(통합순위) 사용 | `composite_rank` 통일 |
| 4 | HIGH | `create_current_portfolio.py:668` | T-1/T-2 맵 `rank<=30` 조건 + 불일치 fallback | `.get('composite_rank', item['rank'])` 통일 |
| 5 | HIGH | `gemini_analysis.py:349` | AI 프롬프트 궤적 역순 | T-2→T-1→T0 시간순으로 수정 |
| 6 | MEDIUM | `send_telegram_auto.py:782` | 웹 캐시 Death List `rank` 사용 | `composite_rank` 수정 |
| 7 | MEDIUM | `gemini_analysis.py:171` | AI "어제 시장" → 기준일-1일 검색 | `{date_str}` 기준일 명시로 수정 |

#### 설계 원리 (확인됨)
```
rank (통합순위)       = 3일 가중 계산 후 정렬 위치 → 멤버십 판단에만 사용 (Top 30 경계)
composite_rank (멀티팩터순위) = 당일 순수 멀티팩터 순위 → 사용자 표시 + 가중 계산 입력에 사용
```

#### 검증 결과 (5개 규칙 전체 PASS)
- 궤적 순서: T-2→T-1→T0 (시간순) — 3개 위치
- 표시 순위: `composite_rank` 사용 — 9개 위치
- 멤버십 체크: `rank` 사용 — 5개 위치
- 3일 교집합: `composite_rank` 기반 — 3개 위치
- 팩터 점수: 존재 확인 — 3일 데이터

#### 추가 수정
- README.md: Death List Top50→Top30, 궤적 시간순 설명
- MEMORY.md: Death List Top50→Top30

---

## 핵심 변경사항 (v19.1 — composite_rank 분리, 누적 방지)

### 2026-02-20

**배경**: v19.0에서 가중순위를 JSON `rank`에 저장 → 다음 날 그 가중순위를 T-1로 참조 → 또 가중 → 누적(cascading) 문제 발생. 올바른 구조: JSON에 `composite_rank`(순수 점수 순위)를 별도 저장, 가중순위는 항상 composite에서 계산.

| 항목 | v19.0 (잘못됨) | v19.1 (수정) |
|------|-------------|-------------|
| JSON rank | 가중순위 | 가중순위 (Top 30 경계용) |
| JSON composite_rank | 없음 | **신규** — 순수 멀티팩터 점수 순위 |
| T-1/T-2 참조 | rank (가중→누적!) | **composite_rank** (순수→누적 없음) |

#### 핵심 로직
```
1. 멀티팩터 점수 → composite_rank (1~200) — 매일 독립적
2. 이전 2일 JSON에서 composite_rank 조회 = T1, T2
3. 가중순위 = composite_T0 × 0.5 + composite_T1 × 0.3 + composite_T2 × 0.2
4. 가중순위로 정렬 → rank 1~N → Top 30 확정
```

#### 변경 파일
- `create_current_portfolio.py`: composite_rank 필드 추가 + T-1/T-2 lookup 수정
- `state/ranking_*.json`: 6개 날짜 composite_rank 추가 + rank 재계산
- `migrate_weighted_ranks.py`: 마이그레이션 스크립트 수정

---

## 핵심 변경사항 (v18.5 — 가중치 개편 + AI 강화)

### 2026-02-20

**배경**: 순위 변동이 너무 적다는 피드백. 분석 결과: (1) Quality 25%가 FnGuide 주간 캐시라 매일 동일값 (2) Momentum 20%가 너무 낮아 주가 변동 반영 미미 (3) AI 분석이 인사말+뻔한 문구로 정보가 없음

| 항목 | Before | After |
|------|--------|-------|
| 가중치 | V45 + **Q25** + G10 + **M20** | V45 + **Q15** + G10 + **M30** |
| 모멘텀 공식 | `(12M - 1M) / σ` | `(12M - 1M) / σ` **(유지)** |
| AI 리스크 [2/3] | 인사말 있음, "이번 주" 요약 | 인사말 금지, "어제 마감" 집중 |
| AI 추천 [3/3] | 일반적 생성 | **Google Search Grounding** (실시간 검색) |
| 순위 재계산 | - | 전체 날짜(20260209~20260219) 새 가중치로 재생성 |

#### 왜 (12M-1M)/σ를 유지하는가
- 한국 시장은 개인 투자자 비중이 높아 **단기 반전 효과가 더 강함**
- 3일 검증(✅)은 하루 노이즈 필터지, 2~4주 반전 필터가 아님
- 12M/σ로 변경 시 추격매수 위험 + 회전율 500%+ → 거래비용 과다
- **순위 다이나믹 문제의 본질은 가중치**(M20→M30)이지 공식이 아님
- 제룡전기 같은 12개월 꾸준 상승 종목은 (12M-1M)/σ에서도 포착됨

#### 변경 파일
- `strategy_b_multifactor.py`: 가중치 변경 (Q25→Q15, M20→M30), 공식 유지
- `gemini_analysis.py`: 인사말 금지 + 어제 집중 + Google Search Grounding + 서두 자동 제거
- `send_telegram_auto.py`: 오늘의 메시지 섹션 제거
- `state/ranking_*.json`: 6개 날짜 전체 재계산

---

## 핵심 변경사항 (v18.4 — UX 정리 + Gemini 서두 제거)

### 2026-02-20

| 항목 | 변경 |
|------|------|
| Gemini 서두 | 프롬프트에 서두/인사말 금지 명시 + `_convert_picks_markdown()`에서 `**1.` 앞 텍스트 자동 삭제 |
| 📩 오늘의 메시지 | 📖 투자 가이드에서 `[1/3] [2/3] [3/3]` 목차 삭제 (불필요) |
| 읽는 법 | 시장위험신호↔매수후보 줄바꿈 추가 (이전 세션) |

#### 변경 파일
- `gemini_analysis.py`: 서두 금지 프롬프트 + 자동 제거 로직
- `send_telegram_auto.py`: 오늘의 메시지 섹션 제거

---

## 핵심 변경사항 (v18.3 — FnGuide 병렬화 성능 개선)

### 2026-02-19 FnGuide 재무제표 + 컨센서스 4스레드 병렬화

**배경**: 워크플로우 실행시간 8~10분으로 과다. 분석 결과 `create_current_portfolio.py` 내 FnGuide 크롤링이 전체의 80% 차지. `refresh_fnguide_cache.py`에서는 이미 4스레드 병렬을 사용하고 있었으나, 본체(`fnguide_crawler.py`)에서는 순차 처리.

#### 변경 사항

| 함수 | Before | After | 효과 |
|------|--------|-------|------|
| `get_all_financial_statements()` | `for ticker in tqdm(tickers)` 순차 | `ThreadPoolExecutor(4)` 병렬 | 596종목 캐시 로드 병렬화 |
| `get_consensus_batch()` | `for i, ticker in enumerate(tickers)` + `sleep(1)` | `ThreadPoolExecutor(4)` 병렬 + 스레드별 `sleep(1)` | 200종목 크롤링 4배속 |

#### 성능 결과

| 구간 | Before | After |
|------|--------|-------|
| `create_current_portfolio.py` | 396초 (6.6분) | **97초 (1.6분)** |
| 전체 워크플로우 | 8분 20초 | **3분 40초** |

#### 수정 파일
- `fnguide_crawler.py` — `get_all_financial_statements()`, `get_consensus_batch()` 2개 함수

---

## 핵심 변경사항 (v18.2 — 현금비중 % 제거 + 행동 등급 시스템 + VIX 퍼센타일)

### 2026-02-18 현금비중 → 행동 가이드 전환

**배경**: 기존 시스템은 VIX 수준에 따라 현금비중을 ±5~15% 가감했으나, 실제 포트폴리오는 항상 5종목×20% 고정이라 수치가 무의미. 미국 프로젝트(eps-momentum-us v31)에서 동일한 이유로 이미 현금비중 % 제거 완료. 한국 프로젝트도 동일 적용.

**핵심 원칙**: "표시하는 숫자와 실제 행동이 일치해야 한다."

#### 주요 변경

| 항목 | Before | After |
|------|--------|-------|
| VIX 기준 | 절대값 (20/25/35 고정) | **252일 퍼센타일** (적응형) |
| 현금비중 | cash_pct 0~70% 산출 | **완전 제거** (cash_adjustment=0) |
| KR 가감 | adjustment 0/10/20 | **제거** (레짐 정보만) |
| 최종 출력 | `💰 투자 80% + 현금 20%` | `→ [행동 가이드 텍스트]` |
| 행동 결정 | cash_pct 기반 분기 | **HY분면 × q_days × n_ok × Concordance** |
| Concordance | 현금% 가감 조절 | **행동 톤 강화/완화** |
| Gemini 프롬프트 | `현금 비중 권고: X%` | `행동 권장: [action]` |

#### 행동 등급 매트릭스 핵심

- **Q1 봄**: 적극 매수 (n_ok에 따라 강도 조절)
- **Q2 여름**: 평소대로~신중~줄이세요
- **Q3 가을**: q_days < 60 신중, ≥ 60 줄이세요~멈추세요
- **Q4 겨울**: ≤20일 매도(최강), 20~60일 관망, **>60일 분할 매수**(Q1 전환 사전 포석)
- **💎 해빙/VIX 공포완화**: 분할 매수 시작!

**30년 데이터 근거**:
- Q4 초기(≤20일): 20일 수익 -0.5~0% → 가장 위험
- Q4 후기(>60일): 60일 수익 +1.5~2.5% → 사실상 Q1 수준
- Q4→Q1 전환: 250일 수익 +8~12% → 역사적 최고 매수 기회

#### 변경 파일

| 파일 | 변경 |
|------|------|
| `credit_monitor.py` | fetch_vix_data 퍼센타일, fetch_hy_quadrant cash_pct 제거, fetch_kr_credit_spread adjustment 제거, _synthesize_action 전면 개편, get_credit_status cash 로직 제거, format_credit_section 현금% → 행동 가이드 |
| `send_telegram_auto.py` | cash_pct 참조 전부 제거, format_overview/format_top30/format_buy_recommendations 수정 |
| `gemini_analysis.py` | build_prompt/build_final_picks_prompt에서 cash_pct → action 기반 |

#### 구분선 정리 (US 프로젝트 패턴 적용)

**규칙**: 같은 카테고리 = 빈줄 또는 없음, 다른 카테고리 = `─────────────────` 구분선

| 위치 | Before | After | 이유 |
|------|--------|-------|------|
| 날짜↔지수 | `─────` | 제거 | 같은 "시장 현황" |
| Top30 타이틀↔본문 | `─────` | 제거 | 같은 카테고리 |
| ✅↔⏳↔🆕 그룹 간 | `─────` | 빈줄 | 같은 "종목 상태" |
| 종목 간 (fallback) | `──────` | 빈줄 | 같은 카테고리 |

---

## 핵심 변경사항 (v18.1 — 전략 밸런스 리뷰 + MA120 추세 필터)

### 2026-02-18 전략 밸런스 리뷰: 6개 항목 논의 → MA120+5%버퍼 적용

**배경**: 2026-02-15 작성된 "BALANCED STRATEGY REVIEW" 문서를 기반으로 시스템 전반의 개선 사항을 검토. 10개 개선안 중 6개 핵심 항목을 우선순위별로 하나씩 논의하여 방향 확정. **모든 결정을 코딩 전에 먼저 확정**하는 방식으로 진행.

#### 논의 항목 및 결정 사항

| # | 항목 | 결정 | 근거 |
|---|------|------|------|
| 1 | **모멘텀 제거/유지** | **유지** | 한국 불장에서 모멘텀 유효. compare_momentum.py로 A/B 비교 결과 제거 시 실익 미미. 학술적으로 한국 모멘텀은 장기 음수이나, 현재 불장에서는 승자가 계속 이기는 패턴 확인 |
| 2 | **팩터 비중 최적화** | **현재 유지** (V45/Q25/G10/M20) | 5개 비중 조합 비교 결과 Top5가 모든 조합에서 안정적. A→B/C/D 모두 27~28/30 겹침으로 미세조정 실익 적음. Growth 10%가 소수 성장주에 집중된 레버리지 역할 수행 |
| 3 | **MA60 추세 필터** | **MA120 + 5% 버퍼로 변경** | 60일은 단기 조정에 너무 민감. 120일로 확대하여 중장기 추세 판단 + 5% 버퍼로 경계선 종목 보호. 가치 함정은 여전히 차단 |
| 4 | **종목 수 확대** | **5종목 유지** | 미국 프로젝트도 5종목 집중. 3중 안전장치(3일 교집합+Death List+시장위험지표)가 집중 리스크를 충분히 관리. 불장에서 집중이 분산보다 유리 |
| 5 | **재진입 프로토콜** | **현재 유지** (제한 없음) | 3일 교집합 자체가 whipsaw 방지 역할. 추가 쿨다운/조건은 오버엔지니어링 |
| 6 | **재벌그룹 집중 제한** | **안 함** | 종목 수 5개 + 자연 분산으로 불필요 |

#### 팩터 비중 분석 상세

**팩터 상관관계** (2026-02-13 기준):
| 팩터 쌍 | 상관계수 | 해석 |
|----------|----------|------|
| Value vs Momentum | **-0.389** | 저평가 종목은 모멘텀이 약한 경향 |
| Value vs Growth | **-0.350** | 저평가 종목은 성장성이 낮은 경향 |
| Growth vs Momentum | **+0.332** | 성장주와 모멘텀이 같은 방향 |
| Quality vs Growth | +0.245 | 약한 양의 상관 |
| Quality vs Momentum | -0.070 | 거의 독립적 (좋은 분산 효과) |
| Value vs Quality | -0.070 | 거의 독립적 |

**Top 30 팩터 분포**:
- Value: 평균 +0.262, **9/30개 음수** (M/Q/G가 Value 불이익 극복하고 진입)
- Momentum: 평균 +0.628, **13/30개 음수** (포트폴리오가 모멘텀에 치우치지 않음)
- Growth: 가장 높은 분산 (std 0.911) — 소수 종목에 집중된 효과

**Growth 10% 기여도 분석**:
- SK하이닉스: Growth가 총점의 **29.9%** 기여 (10% 비중인데 3배 기여)
- SK스퀘어: Growth가 총점의 **37.7%** 기여
- Growth 0%로 변경 시: CS Wind, 현대홈쇼핑, VM이 Top30에서 탈락 → 저성장 종목으로 교체

**5개 비중 조합 Top30 겹침 분석**:
| 조합 | Top30 AvgPER | A와 겹침 |
|------|:---:|:---:|
| A 현재 V45/Q25/G10/M20 | 16.9~18.1 | - |
| B V50/Q30/G0/M20 | 15.8~16.6 | 27/30 |
| C V40/Q25/G15/M20 | 17.8~18.7 | 27/30 |
| D V40/Q30/G10/M20 | 17.0~17.8 | 28/30 |
| E V35/Q25/G15/M25 | 21.4~21.7 | 24/30 |

**결론**: 미세 조정으로 2~3개 종목만 교체되므로, 비중 변경보다 다른 개선(MA필터)에 집중하는 것이 효과적.

#### 모멘텀 A/B 비교 (`compare_momentum.py`)

기존 ranking JSON을 재채점하여 모멘텀 유/무 비교:
- **A (현재)**: V45/Q25/G10/M20
- **B (제안)**: V50/Q30/G20/M0

결과:
- Top 10 중 7~8개 종목 동일, 순위 약간 변동
- 모멘텀 제거 시 Top 30에서 평균 2~3개 종목 교체
- 현재 불장에서 모멘텀이 winners를 상위에 유지시키는 역할 확인
- **결론**: 불장 유지 중에는 모멘텀 제거 부적절, 시장 레짐 전환 시 재검토

#### MA120 + 5% 버퍼 변경 상세

| 항목 | Before (v18.0) | After (v18.1) |
|------|----------------|---------------|
| 이동평균 기간 | 60일 | **120일** |
| 버퍼 | 없음 (칼같은 이진 판단) | **5% 버퍼** (MA120×0.95 이상이면 통과) |
| 최소 데이터 | 60일 | **120일** |
| 함수명 | `apply_ma60_filter()` | **`apply_ma120_filter()`** |
| 조건 | `현재가 >= MA60` | **`현재가 >= MA120 × 0.95`** |

변경 이유:
1. **60일은 너무 짧음** — 2~3개월 단기 조정에도 걸려서 좋은 종목이 불필요하게 제외
2. **칼같은 이진 판단 완화** — MA 대비 0.1%만 아래여도 제외하던 문제 해결
3. **120일 = 6개월 추세** — 더 안정적인 중장기 추세 판단
4. **5% 버퍼** — 단기 조정(-5% 이내)은 허용, 본격 하락 추세만 차단

**수정 파일**:
1. `create_current_portfolio.py` — `apply_ma60_filter()` → `apply_ma120_filter()`, 조건/로그 6곳 수정
2. `gemini_analysis.py` — 코멘트 MA60 → MA120 (2곳)
3. `ranking_manager.py` — 코멘트 MA60 → MA120 (1곳)
4. `send_telegram_auto.py` — 투자 가이드 "60일 이동평균선" → "120일 이동평균선 근처(95%)" (1곳)
5. `README.md` — MA60→MA120 문서 업데이트
6. `SESSION_HANDOFF.md` — 전략 리뷰 논의 내용 + 변경 기록

**변경하지 않은 MA60 참조** (의도적 유지):
- `send_telegram_auto.py` 시장 지수 경고 (MA5/MA20/MA60) — 시장 지수 진단은 종목 필터와 별개 기능

---

## 핵심 변경사항 (v18.0 — 전략-구현 일치 대규모 리팩토링)

### 2026-02-13 전략 철학 "좋은 종목을 싸게, 베타 위험 회피 + 기회 포착" 구현 완성

**배경**: 7가지 전략-구현 불일치 + 4가지 버그/개선 사항 일괄 수정.

| # | 문제 | 수정 내용 |
|---|------|----------|
| 1 | final_action이 HY만 사용 | `_synthesize_action()` — 3지표 종합 멘트 (Q1~Q4 × 안정/경고 조합) |
| 2 | 종목 수와 현금 비중 혼동 | 종목 수는 항상 MAX_PICKS(5), 현금 비중은 별도 권고로 분리 |
| 3 | AI가 시장 환경 모름 | `market_context` 파라미터 → 프롬프트에 국면/현금비중/행동권장 전달 |
| 4 | 가이드에 현금비중 설명 없음 | `format_overview()` — 시장 위험 신호 읽는 법 섹션 추가 |
| 5 | 이탈 사유 미표시 | `_compute_exit_reason()` — V/Q/M 스코어 비교 [V↓ Q↓ M↓] 태그 |
| 6 | 봄(Q1) 기회 강조 약함 | 💎 역사적 매수 기회 블록 (Q1 + 3/3 안정 시) |
| 7 | 이탈 경보 톤 동일 | cash>=50%: 🚨 즉시 매도, >=30%: ⛔ 경계, <30%: ⛔ 검토 |
| A | HY 실패 시 VIX 무시 버그 | else 블록에서도 kr_adj + vix_adj 적용 |
| B | [3/3]에 현금 비중 누락 | 🚨 시장 위험 권고: 현금 N% 보유 추천 라인 추가 |
| C | Gemini 포트폴리오에 시장환경 누락 | `build_final_picks_prompt()`에 market_context |
| D | 투자 가이드에 "종목 수 UP/DOWN" 잔재 | 현금 비중 중심 문구로 통일, 불필요 문구 삭제 |

**수정 파일**:
1. `credit_monitor.py` — `_synthesize_action()` 신규, HY 실패 시 VIX 적용, Q1 강조
2. `send_telegram_auto.py` — 종목 수 고정(MAX_PICKS), 가이드 확장, 이탈 차등, 현금 비중 별도 권고
3. `gemini_analysis.py` — `market_context` 파라미터 (리스크 + 포트폴리오 프롬프트)
4. `ranking_manager.py` — `_compute_exit_reason()` 신규, 이탈 사유 태그
5. `test_ui_preview.py` — 새 구조 반영

---

## 핵심 변경사항 (v17.9 — 시장 위험 지표 UI 리디자인 + 사계절 비유)

### 2026-02-13 시장 위험 지표 리디자인: 카테고리 분리 + 사계절 비유 + 구분선 버그 수정

**배경**: "신용시장"이라는 제목 아래 VIX(변동성)가 함께 표시되어 개념 혼동 발생. 카테고리를 분리하고 사계절 비유로 직관성 개선.

| 항목 | Before (v17.8) | After (v17.9) |
|------|----------------|---------------|
| 섹션 타이틀 | `🟢 신용시장 — 성장기` | `🌡️ 시장 위험 지표 — ☀️ 여름` |
| 분면 레이블 | 회복기/성장기/과열기/침체기 | **🌸봄/☀️여름/🍂가을/❄️겨울** |
| 카테고리 | 단일 블록 | **🏦 신용시장 + ⚡ 변동성** 분리 |
| 결론 아이콘 | `📊 투자 80%` | `💰 투자 80%` |
| VIX 아이콘 | `📊 VIX(변동성)` | `VIX 17.6` (헤딩 아래) |
| 주도업종 구분선 | **버그**: 텍스트와 `───` 연결됨 | **수정**: `\n` 추가 |

**아이콘 체계** (📊 주도업종과 중복 방지):
- 🌡️ 시장 위험 지표 (타이틀)
- 🌸/☀️/🍂/❄️ 사계절 (HY 4분면 매핑)
- 🏦 신용시장 / ⚡ 변동성 (카테고리)
- 💰 투자 비중 (결론)
- 📊 주도 업종 (기존 유지)

**수정 파일**:
1. `credit_monitor.py` — 사계절 레이블 + `format_credit_section()` 카테고리 분리
2. `send_telegram_auto.py` — 주도업종 구분선 `\n` 버그 수정 + 코멘트 업데이트
3. `test_ui_preview.py` — 새 구조 반영
4. `README.md` / `SESSION_HANDOFF.md` — 문서 업데이트

**텔레그램 [1/3] 메시지 예시**:
```
─────────────────
🌡️ 시장 위험 지표 — ☀️ 여름(성장국면)

🏦 신용시장
▸ HY Spread(부도위험) 2.84%
  평균(3.76%)보다 낮아서 안정적이에요.
▸ 한국 BBB-(회사채) 6.4%p
  정상 범위에요.

⚡ 변동성
▸ VIX 17.6
  평균(17.4) 이상, 안정적이에요.

🟢🟢🟢 3/3 안정 — 확실한 신호
💰 투자 80% + 현금 20%
→ 평소대로 투자하세요.
```

---

## 핵심 변경사항 (v17.8 — VIX Layer 3 구현)

### 2026-02-13 VIX Layer 3 구현: FRED VIXCLS 수집 + Concordance Check + 텔레그램 표시

**배경**: v17.7에서 두 에이전트가 독립 연구한 VIX 분석 결과를 실제 코드로 구현. `credit_monitor.py`에 `fetch_vix_data()` 함수를 추가하고, `get_credit_status()`에 Layer 3 + Concordance Check를 통합.

| 항목 | Before (v17.7) | After (v17.8) |
|------|----------------|---------------|
| VIX | 분석/설계 문서만 | **`fetch_vix_data()` 구현, 실데이터 수집** |
| 현금비중 | HY + BBB- 2레이어 | **HY + BBB- + VIX 3레이어** |
| Concordance | 설계만 | **`get_credit_status()` 내 구현** |
| 텔레그램 | VIX 표시 없음 | **`format_credit_section()` VIX 블록 추가** |

**수정 파일**:
1. `credit_monitor.py` — `fetch_vix_data()` 신규 + `get_credit_status()` L3/Concordance + `format_credit_section()` VIX 표시

**구현 상세**:
```
fetch_vix_data():
  FRED VIXCLS CSV (~400일) → 5일 slope (±0.5 threshold)
  레짐 7종: normal / elevated / high / crisis / crisis_relief / stabilizing / complacency
  cash_adjustment: -10% ~ +15%
  direction: 'warn' (crisis/high/elevated/complacency) 또는 'stable'

get_credit_status() Concordance:
  both_warn   → VIX 전액 적용
  hy_only     → VIX 0% (스텔스 위기 - HY가 이미 반영)
  vix_only    → VIX 50%만 (일시적 쇼크)
  both_stable → VIX 그대로 (보통 0%)

  final_cash = max(0, min(70, base_cash + kr_adj + vix_adj))
```

**검증 결과** (2026-02-13 실행):
```
[HY] 2.84% | Q2 ☀️여름 (29일째) → 현금 20%
[KR] BBB- 6.39%p → 정상 → 가감 0%
[VIX] 17.6 | slope -4.1 (falling) → 안정 → 가감 0%
Concordance: both_stable
최종 현금비중: 20% (HY 20 + KR +0 + VIX +0)
```

---

## 핵심 변경사항 (v17.7 — VIX 분석 + 3레이어 복합 모델 설계)

### 2026-02-13 VIX 분석: 에이전트 독립 연구 → 3레이어 복합 모델 도출

**배경**: 두 독립 에이전트(한국 퀀트 전략 + US EPS 모멘텀 전략)가 각각 VIX 35년 데이터(1990~2025)를 자유롭게 EDA하고, 별도 논의 없이 동일한 핵심 결론 3가지에 도달.

#### 에이전트 개요

| 구분 | 한국 퀀트 에이전트 | US EPS 에이전트 |
|------|-------------------|-----------------|
| 토큰 | ~64,000 | ~70,000 |
| 도구 사용 | 21회 | 31회 |
| 소요 시간 | ~5분 | ~5분 |
| 접근 방식 | FRED VIXCLS 직접 분석 + 웹 리서치 | FRED VIXCLS 직접 분석 + 학술 문헌 |

#### 공통 결론 3가지

**결론 1: VIX 단독 사용 금지 → HY의 보조 레이어로만**

VIX를 단독 지표로 현금비중을 결정하면 whipsaw(짧은 기간 잦은 신호 변경)가 심각함.
- VIX half-life 2~10일 → 레짐 전환이 너무 빠름
- 2007년 문제: VIX 정상, HY는 이미 확대 중 → VIX만 보면 서브프라임 위기 놓침
- 반대로 LTCM(1998): VIX 스파이크, HY 별무 → VIX만 보면 과잉 대응
- **따라서**: HY가 구조적 방향(방향타), VIX는 순간 변동성(속도계) → 보조만 담당

**결론 2: Concordance Check (신호 일치/불일치 해석)**

단순 VIX 수치 기반 현금 가감보다, HY 신호와의 일치/불일치를 체크하는 것이 더 효과적.

| HY 방향 | VIX 방향 | 해석 | 대응 |
|----------|----------|------|------|
| 같은 방향 경고 | 같은 방향 경고 | 이중 확인 | 전액 적용 |
| **HY만 경고** | VIX 안정 | **스텔스 위기** (2007) | **전액 + 추가 경계** |
| HY 안정 | **VIX만 경고** | **일시적 쇼크** (Flash Crash) | **50%만 적용** |
| 같은 방향 안정 | 같은 방향 안정 | 정상 상태 | 0% 가감 |

왜 Concordance가 단순 합산보다 나은가:
- 단순 합산: HY 현금 20% + VIX 현금 15% = 35% → 기계적, 뉘앙스 없음
- Concordance: HY만 경고 → "보이지 않는 위기 징후" → 특별 경계 → 능동적 해석

**결론 3: VIX 40+ 하락 전환 = 역사적 최고 매수 기회**

VIX 40 이상 도달 후 **하락 전환**하는 시점이 가장 수익률 높은 진입점.
- 12개월 평균 수익률 +23.4%
- VIX 40+ 도달 후 3년 이내 예외 없이 시장 회복
- 단, 하락 전환 **전**까지는 추가 급락 가능 → 분할 매수 병행

VIX 40+ 역설:
- 뇌: "무서우니까 현금 늘려야지" → 틀림
- 데이터: "공포가 극점에서 꺾이면 가장 큰 수익" → 맞음
- VIX 40+ 자체가 시장이 이미 20~30% 급락한 후에 도달 → 이후는 반등 구간
- VIX 40+ 일수 = 평균 3.2일 클러스터 → 2~4일 연속 뒤 급속 정상화

#### 한국 특화 고려사항

| 항목 | 내용 |
|------|------|
| VKOSPI | VIX→VKOSPI 단방향 인과관계 (Granger causality) |
| 시차 | VIX 스파이크 → 1~2 거래일 후 VKOSPI 반응 → **선제 대응 가능** |
| 환율 | 원/달러 환율과 VIX 동시 반응 → **이중 충격** (환차손 + 주가 하락) |
| 레이어 구조 | HY(L1) + BBB-(L2) + VIX(L3) → 3중 레이어 |

#### 3레이어 복합 모델

```
Layer 1 (기존): HY Quadrant → 기본 현금비중
Layer 2 (기존): 한국 BBB- → 한국 신용 가감
Layer 3 (신규): VIX Adjustment → VIX 상태에 따른 가감

최종 현금비중 = Layer1 + Layer2 + Layer3 (cap: 0~70%)
```

**Layer 3 VIX 가감 규칙**:

| VIX 조건 | 가감 | 이유 |
|----------|------|------|
| VIX > 35, ↑상승 | +15% | 위기 모드 |
| VIX 25~35, ↑상승 | +10% | 상승 경계 |
| VIX 20~25, ↑상승 | +5% | 경미한 경계 |
| VIX < 12 | +5% | Complacency 경고 |
| **VIX > 35, ↓하락** | **-10%** | **공포 해소 = 매수 기회** |
| VIX 20~25, ↓하락 | -5% | 안정화 중 |

#### 백테스트 규칙 (구현 시)

| 규칙 | 조건 | 행동 |
|------|------|------|
| V1 | VIX>30, 5일Δ>10 | 현금 +15~20% |
| V2 | VIX>40, 5일Δ<0 | 현금 -15~20% (패닉 후 회복) |
| V3 | VIX<15 20일 연속 | 현금 -5% |
| V4 | VIX/VIX3M>1.0 | 현금 +10% (백워데이션) |
| V5 | HY Q4 + VIX 30+ | 현금 = 70% (이중 위험) |
| V6 | HY Q1 + VIX 하락 | 현금 = 0% (이중 안전) |
| V7 | HY Q4 + VIX 급락(-10pt/5d) | 현금 40% (VIX 선행 회복) |

#### 구현 우선순위

① FRED VIXCLS 수집 → ② VIX Layer 3 통합 → ③ 텔레그램 VIX 표시 → ④ VIX3M term structure → ⑤ 백테스트

#### 참고 소스

- FRED: VIXCLS (1990~), VXVCLS/VIX3M (2007.12~)
- Hartford Funds: VIX 레벨별 향후 수익률 실증
- WisdomTree: VIX Term Structure 분석
- BlackRock: VIX+HY 복합 지표 연구
- Verdad Capital: HY 4분면 모델 (기존)

---

## 핵심 변경사항 (v17.6 — 메시지 가독성 개선)

### 2026-02-13 Top 30 개별 종목 라인 + 구분선 + 읽는 법 압축

**변경 내용**:
1. `format_top30()`: 쉼표 나열 → 개별 줄 + 그룹 간 구분선
2. 헤더 빈 줄 → `─────────────────` 구분선 교체
3. 읽는 법 3줄 → 1줄 압축 (`✅매수 ⏳내일검증 🆕관찰`)
4. AI 푸터 `\n\n` → `\n─────────────────\n`
5. `format_overview()`, `format_buy_recommendations()` 빈 줄 → 구분선

---

## 핵심 변경사항 (v17.5 — 신용시장 모니터링 + 현금비중 자동 조절)

### 2026-02-13 신용시장 모니터 도입: US HY Spread 4분면 + 한국 BBB- 스프레드

**배경**: 미국 프로젝트(eps-momentum-us)의 HY Spread Verdad 4분면 모델을 한국 프로젝트에 이식. 글로벌 신용 사이클에 따라 현금비중을 자동 조절하여 매크로 리스크 대응.

| 항목 | Before (v17.4) | After (v17.5) |
|------|----------------|---------------|
| 현금비중 | 고정 0% (5종목 × 20%) | **동적 0~70%** (신용시장 상태에 따라) |
| 종목당 비중 | 고정 20% | **고정 20%** (현금비중과 무관) |
| 신용시장 | 없음 | **US HY 4분면 + 한국 BBB- 스프레드** |
| 텔레그램 | 시장지수 + MA 경고만 | **+ 신용시장 섹션 (분면/현금비중/해빙신호)** |

**이중 레이어 모델**:
```
Layer 1 (미국 HY): FRED BAMLH0A0HYM2 → Verdad 4분면 → 기본 현금비중
  🌸 봄(Q1): 0% | ☀️ 여름(Q2): 20% | 🍂 가을(Q3): 20~30% | ❄️ 겨울(Q4): 30~70%

Layer 2 (한국 BBB-): ECOS API (회사채 BBB- - 국고채 3년)
  정상: 가감 0% | 경계: +10% | 위기: +20%

최종 현금비중 = Layer1 + Layer2 (cap: 0~70%)
```

**FRED 데이터 갱신 타이밍**: T+1 영업일 오전 8:49 AM CST = 밤 11:49 PM KST
→ 다음 날 새벽 06:30 KST 워크플로우 실행 시 전일 미국장 데이터 확보 가능

**텔레그램 [1/3] 메시지 예시** (v17.9에서 UI 리디자인됨):
```
🌡️ 시장 위험 지표 — ☀️ 여름
🏦 신용시장: HY 2.84% + 한국 BBB- 6.4%p
⚡ 변동성: VIX 17.6
💰 투자 80% + 현금 20%
```

**수정/추가 파일**:
1. `credit_monitor.py` — 신규: US HY 4분면 + 한국 BBB- + 통합 현금비중
2. `send_telegram_auto.py` — 시장 위험 지표 섹션 삽입 + 종목당 고정 20% 비중
3. `config.py` — `ECOS_API_KEY` 추가
4. `.github/workflows/telegram_daily.yml` — `ECOS_API_KEY` secret 반영
5. `README.md` — 신용시장 문서 추가

**GitHub Secrets 추가**: `ECOS_API_KEY` (한국은행 ECOS API 키)

---

## 핵심 변경사항 (v17.4 — 섹터 세분화 + 상단 컴팩트 표시)

### 2026-02-13 섹터 세분화: "제조 30%" → 전기전자/화학/기계 등 구체적 분류

**배경**: v17.3에서 KRX 업종지수 자동 수집을 도입했으나, KOSDAQ `2024`(제조) 상위 인덱스가 1,115종목을 뭉뚱그려 Top 30의 30%가 "제조"로 표시됨. 하위 세부 인덱스(전기전자 313개, 화학 125개, 기계 185개 등)가 별도로 존재하는데 상위 인덱스도 같이 수집 → `drop_duplicates(keep='first')`로 "제조"가 우선됨.

| 항목 | Before (v17.3) | After (v17.4) |
|------|----------------|---------------|
| KOSDAQ 제조 | `2024` 상위 인덱스 포함 (1,115종목 뭉치) | **`2024` 제거, 하위 세부만 사용** |
| KOSDAQ 세부 | 4개 누락 (제약, 의료정밀, 종이/목재, 출판/매체) | **`2062`~`2074` 추가 (4개)** |
| 대분류 매핑 | 12개 통합 (전기전자→반도체/전자, 기계→에너지/유틸) | **최소 통합 — KRX 원래 이름 유지** |
| 표시 위치 | [1/3] 하단 블록 | **[1/3] 상단 한 줄** (미국 프로젝트 스타일) |
| 표시 형식 | `제조 9개(30%) · 소비재 5개(17%)` | **`전기전자 5 · 유통 5 · 화학 5 · 기계 4`** |

**최소 통합 매핑** (유사 업종만 합산, 나머지는 KRX 이름 그대로):
```
바이오/제약+제약 → 바이오/제약   의료정밀 → 의료기기
운수장비 → 자동차   전기가스 → 에너지/유틸   운수창고 → 물류
금융+증권+보험 → 금융   출판/매체 → 미디어   기타제조 → 기타
전기전자, 화학, 기계, 유통, 음식료, 건설, 서비스, 통신, IT서비스 ... → 그대로
```

**메시지 예시** ([1/3] 상단, 읽는 법 바로 아래):
```
📊 주도 업종: 전기전자 5 · 유통 5 · 화학 5 · 기계 4 · 금융 3 · 통신 3 · ...
```

**수정 파일**:
1. `data_collector.py` — `2024`(제조) 제거, `2062`/`2063`/`2066`/`2074` 추가
2. `create_current_portfolio.py` — `KRX_SECTOR_MAP` 최소 통합으로 변경
3. `send_telegram_auto.py` — `SECTOR_DB` 제거, 상단 한 줄 컴팩트 형식, AI 섹터는 `pick.get('sector')` 방식

**주의**: `data_cache/krx_sector_*.parquet` 캐시가 이전 분류(제조 포함)로 남아있으면 새 코드가 무시됨. GitHub Actions data-cache 삭제 필요: `gh cache list | grep data-cache` → `gh cache delete <id>`

---

## 핵심 변경사항 (v17.2 — AI 리스크 필터 전체 후보 대상 확대)

### 2026-02-13 AI 리스크 필터 범위 확대 + 워크플로우 git stash 수정

**배경**: AI 리스크 필터가 최종 picks 5개에만 적용되어, 상위 종목이 리스크 플래그로 빠질 때 대체 후보(6위~)가 리스크 미검증 상태였음. 또한 워크플로우에서 data_cache 등 untracked 파일로 인해 `git pull --rebase` 실패.

| 항목 | Before | After |
|------|--------|-------|
| AI 리스크 대상 | picks 5개만 | **3일 교집합 전체 후보** (하드필터 통과 전원) |
| picks 선정 순서 | 가중순위 상위 5개 → AI 리스크 | **AI 리스크 → 클린 종목 우선 상위 5개** |
| 리스크 플래그 종목 | 경고만 표시 | **경고 + picks 후순위 배치** |
| 워크플로우 commit | `git pull --rebase` 실패 가능 | **`git stash --include-untracked` 후 pull** |

**흐름 변경**:
```
Before: 3일교집합 → 상위5개 잘라서 → AI 리스크(5개만) → 최종 추천
After:  3일교집합 → 전체 하드필터 → AI 리스크(전원) → 클린 우선 상위5개 → 최종 추천
```

**수정 파일**:
1. `send_telegram_auto.py` — 전체 후보 AI 리스크 검사, `compute_risk_flags`로 플래그 종목 후순위 배치
2. `.github/workflows/telegram_daily.yml` — `git stash --include-untracked` + `git stash pop` 추가

---

### 2026-02-12 구분선 간격 축소 + 비중 줄바꿈 + 랭킹 동일 환경 재계산

**배경**: 1) 최종 추천 메시지([3/3])에서 종목 사이 구분선 간격이 과도하게 넓음 2) 비중이 종목명과 같은 줄에 있어 가독성 낮음 3) 0209/0210(로컬)과 0211(워크플로우)의 OHLCV 캐시가 달라 scored 수 불일치 (186 vs 177)

| 항목 | Before | After |
|------|--------|-------|
| [SEP] 치환 | 단순 replace (빈줄 그대로) | **regex로 주변 빈줄 제거** (US 프로젝트 방식) |
| AI 텍스트 감싸기 | 앞뒤 `─────` 구분선 추가 | **제거** (AI 텍스트 내부 구분선만 사용) |
| 비중 위치 | `종목명(티커) · 순위 · 비중 20%` 한 줄 | **비중 다음 줄로 분리** |
| 0209/0210 랭킹 | 로컬 OHLCV (scored 186~187) | **동일 환경 재계산** (scored 186~187) |
| 0211 랭킹 | 워크플로우 OHLCV (scored 177) | **로컬 동일 환경** (scored 186) |

**수정 파일**:
1. `gemini_analysis.py` — `_convert_picks_markdown()` regex 기반 [SEP] 치환, 프롬프트 비중 줄바꿈
2. `send_telegram_auto.py` — AI 텍스트 앞뒤 불필요한 구분선 제거
3. `state/ranking_2026020{9,10,11}.json` — 동일 환경 재계산

---

## 핵심 변경사항 (v17.0 — Growth 팩터 독립 + 매출성장률 추가)

### 2026-02-12 멀티팩터 v6.0: V45 + Q25 + G10 + M20

**배경**: 기존 시스템은 Value+Quality+Momentum만으로 "뭘 살까"는 잘 잡지만, 성장성을 독립 팩터로 평가하지 못함. EPS개선도는 Quality에 묻혀있고, 매출 성장은 아예 반영 안 됨. "좋은 사과를 싸게 사자" + "성장하는 기업 선호" 아젠다를 동시에 충족하기 위해 Growth 팩터를 독립시킴.

| 항목 | Before (v5.0) | After (v6.0) |
|------|---------------|--------------|
| Value | **50%** | **45%** |
| Quality | **30%** (ROE+GPA+CFO+EPS개선도) | **25%** (ROE+GPA+CFO) |
| Growth | 없음 | **10%** (EPS개선도 + 매출성장률) |
| Momentum | **20%** | **20%** (변경 없음) |
| EPS개선도 | Quality 소속 | **Growth 소속** (팩터 분리) |
| 매출성장률 | 없음 | **YoY 연간 매출액 2개년 비교** |

**매출성장률(YoY) 계산** (`fnguide_crawler.py: extract_revenue_growth()`):
```python
# FnGuide 연간 재무제표에서 매출액 2개년 추출
# 90일 공시 시차 적용 (base_date - 90일 이전 공시만 사용)
매출성장률 = (최근매출액 - 전기매출액) / |전기매출액| × 100
# 커버리지: ~97% (557/574개 종목)
```

**Growth 팩터 스코어링** (`strategy_b_multifactor.py`):
```python
# EPS개선도 + 매출성장률 각각 섹터별 z-score → 평균
growth_factors = ['EPS개선_z', '매출성장_z']
data['성장_점수'] = data[growth_factors].mean(axis=1).fillna(0.0)
# NaN 종목 → 성장_점수 0.0 (중립)
```

**가중치 분석** (V45/Q25/G10/M20):
- Value 45% 유지: "싸게 사자" 아젠다 핵심. 50%→45%로 약간만 양보
- Quality 25%: EPS개선도가 Growth로 이관되면서 3개 서브팩터만 남아 비중 축소 합리적
- Growth 10%: 보수적 배분. 성장주 ~40% (12/30) 포함되면서도 가치주 밀어내지 않는 균형점
- Momentum 20%: "빠르게 나온다" Fast Out 핵심. 변경 없음

**OHLCV 캐시 수동 갱신**:
- 기존 캐시: 20241113~20260206 (301 거래일) — 20260207-08 설날 휴장
- 20260209/10/11 거래일 데이터 pykrx로 수동 fetch → 304 거래일로 확장
- 3일치 per-date OHLCV 슬라이싱으로 각 날짜별 정확한 모멘텀 계산
- 결과: 29/30 교집합 (🆕 유바이오로직스, 이탈 씨에스윈드)

**수정 파일**:
1. `strategy_b_multifactor.py` — Growth 팩터 분리 (EPS개선도+매출성장률), 가중치 V45+Q25+G10+M20, calculate_timing() 제거
2. `fnguide_crawler.py` — `extract_revenue_growth()` 함수 추가
3. `create_current_portfolio.py` — v6.0, revenue_growth_df 파라미터, 리포트 텍스트 업데이트
4. `send_telegram_auto.py` — 가이드 문구 미세 조정
5. `state/ranking_2026020{9,10,11}.json` — v6.0 재계산 (per-date OHLCV)
6. `README.md` — v6.0 전략 반영
7. `SESSION_HANDOFF.md` — v17.0 변경사항 추가

---

## 핵심 변경사항 (v16.2 — 급락 하드 필터 + 순위 궤적 트래킹)

### 2026-02-11 급락 하드 필터 + 3일 순위 궤적 + 가중순위 정렬

**배경**: 1) 전일 -5% 급락 종목이 최종 추천에 포함되는 문제 2) 가중순위가 보이지 않아 대안 종목 파악 불가 3) ⏳ 내일 검증 종목의 순위 변동 파악 불가

| 항목 | Before (v16.0) | After (v16.2) |
|------|----------------|--------------|
| 급락 처리 | 경고만 (최종 추천에 포함) | **하드 필터 (전일 -5% → 제외, 다음 순위로 대체)** |
| ✅ 정렬 | T-0 순위 순 | **가중순위 순 정렬** (T0×0.5+T1×0.3+T2×0.2) |
| ✅ 표시 | `SK하이닉스(1)` | **`SK하이닉스(1→1→1위)`** (T-2→T-1→T0 시간순) |
| ⏳ 표시 | `제룡전기(8)` | **`제룡전기(14→8위)`** (T-1→T0 시간순) |
| 🆕 표시 | `코나아이(30)` | `코나아이(30)` (변경 없음) |
| Gemini 프롬프트 | 가중순위 없음 | **`순위 X→Y→Z`** 궤적 포함 |
| AI 출력 형식 | `종목명(티커) · 비중 20%` | **`종목명(티커) · 순위 X→Y→Z · 비중 20%`** |
| 급락 제외 안내 | 없음 | **`⚠️ 종목명(가중 N.N) 전일 -N.N% 급락 → 제외`** |
| 교집합 조회 | max_picks=5 | **max_picks=30** (하드 필터 여유분 확보) |

**하드 필터 vs 소프트 경고**:
```
하드 필터 (최종 추천에서 제외):
  ⚠️ 전일 -5% 급락 → 제외, 다음 가중순위 종목으로 대체

소프트 경고 (AI 리스크 필터에서 경고만):
  🔺 RSI ≥ 80 (극단적 과열)
  🔺 전일 +8% 급등 (추격매수 위험)
  📊 거래량 3배 폭발 (비정상 움직임)
```

**수정 파일**:
1. `send_telegram_auto.py` — max_picks=30 + 하드 필터 루프, ✅ 가중순위 정렬 + 3일 궤적, ⏳ 2일 궤적, format_buy_recommendations에 skipped 파라미터
2. `gemini_analysis.py` — build_final_picks_prompt에 순위 궤적 (rank_t2→rank_t1→rank_t0, 시간순)
3. `test_ui_preview.py` — 실제 2/11 데이터로 전면 갱신, fake_rankings_t0/t1/t2 추가
4. `README.md` — 하드 필터, 순위 궤적 반영
5. `SESSION_HANDOFF.md` — v16.2 변경사항 추가

---

## 핵심 변경사항 (v16.0 — 텔레그램 v8.1 메시지 구조 전면 개편)

### 2026-02-11 4메시지 스토리텔링 + AI 최종 추천 멘트

**배경**: 미국 프로젝트(eps-momentum-us) 메시지 흐름을 참고하여, 고객 관점에서 자연스러운 스토리텔링 구조로 전면 개편. 퍼널 프로세스(후보 → AI 검증 → 최종)를 메시지 순서에 반영.

| 항목 | Before (v15.0) | After (v8.1) |
|------|----------------|--------------|
| 메시지 구조 | 개요 → 본문(Death+매수) → 생존 → AI | **가이드 → [1/3] 시장+Top30 → [2/3] AI 리스크 필터 → [3/3] 최종 추천** |
| Top 30 표시 | 생존 리스트 (순위만) | **상태별 그룹핑** (✅ 3일 검증 / ⏳ 내일 검증 / 🆕 신규 진입) |
| 매도 신호 | Death List (50위 이탈 상세) | **📉 이탈 순위 변동** (어제 18위 → 현재 35위 / 순위권 밖) |
| AI 분석 | AI 브리핑 1개 (리스크만) | **2단계**: 🤖 AI 리스크 필터 + 🎯 최종 추천 AI 멘트 |
| 최종 추천 | PER/PBR/ROE/RSI 숫자 나열 | **AI가 종목별 1-2줄 자연어 설명** (날씨아이콘 🔥☀️🌤️⛅) |
| 최종 추천 헤더 | 없음 | **퍼널 경로** (598종목 → Top 30 → 검증 → 최종 N종목) + **비중 한눈에 보기** |
| 흐름 안내 | 없음 | **"👉 다음: ..."** 플로우 큐 (메시지 간 연결) |
| 메시지 번호 | [1/2] [2/2] | **[1/3] [2/3] [3/3]** |
| AI 이름 | AI 점검 | **AI 리스크 필터** |
| ✅ 라벨 | 매수 대상 / 매수 후보 (혼용) | **3일 검증** (Top 30 내) / 최종 추천은 별도 메시지 |

**새 Gemini 함수 (gemini_analysis.py)**:
```python
run_final_picks_analysis(stock_list, weight_per_stock, base_date)
# → Gemini가 종목당 1-2줄 선정 이유 + 날씨아이콘 생성
# → [SEP] → ────── 구분선 치환
# → AI 실패 시 _get_buy_rationale() fallback
```

**리스크 플래그 정리 (gemini_analysis.py)**:
```
원칙: 4겹 검증을 통과한 종목이므로, 모델이 이미 평가한 항목은 다시 벌점 주지 않는다.
리스크 필터는 "당일 갑자기 발생한 이벤트"만 잡는다. 플래그에 걸려도 최종 추천에서 빠지지 않음.

제거: 📉 52주 -35% 급락 — "싸게 사자" 철학과 정면 충돌 + MA60이 가치함정 차단
제거: 💰 PER > 40 고평가 — Value 50% 가중치 + 유니버스 PER≤60 필터와 중복
완화: 🔺 RSI 75→80 — 극단적 과열만 경고 (Momentum 20%가 이미 평가)
유지: ⚠️ 전일 -5% 급락 — 악재 확인 필요 (당일 이벤트)
유지: 🔺 전일 +8% 급등 — 추격매수 위험 (당일 이벤트)
유지: 📊 거래량 3배 폭발 — 비정상 움직임 (당일 이벤트)
```

**수정 파일**:
1. `send_telegram_auto.py` — v8.1 전면 개편: 4메시지 구조, format_top30 그룹핑, format_buy_recommendations AI 멘트, 2단계 Gemini 호출
2. `gemini_analysis.py` — AI 리스크 필터 이름 변경 + `build_final_picks_prompt()`, `_convert_picks_markdown()`, `run_final_picks_analysis()` 추가
3. `test_ui_preview.py` — v8.1 4메시지 프리뷰 (가짜 데이터)
4. `README.md` — 텔레그램 메시지 섹션 현행화
5. `SESSION_HANDOFF.md` — v16.0 변경사항 추가

---

## 핵심 변경사항 (v15.0 — 텔레그램 UI 강화 + 최종 추천 5종목)

### 2026-02-10 HTML 볼드 + ✅ 마커 + 투자 근거 + 생존 순위 + max_picks 5 + FnGuide 주간 갱신

**배경**: KR/US 텔레그램 UX 비교 분석(12개 개선점 도출) 후 선별 적용. 구독자 친화적 UI 강화 + 고확신 종목 집중.

| 항목 | Before (v14.1) | After (v15.0) |
|------|----------------|---------------|
| 텍스트 강조 | 이모지만 | **`<b>볼드</b>` + `parse_mode='HTML'`** |
| 매수 후보 종목명 | 일반 텍스트 | **✅ `<b>종목명</b>`** (검증 마커) |
| 투자 근거 | 없음 | **한 줄 투자 근거** (실적 개선/저평가/고수익성/과매도/52주 저점) |
| 생존 리스트 | 종목명만 나열 | **종목명(순위)** 형태 |
| 최대 추천 수 | 10종목 | **5종목** (고확신 집중) |
| Death List 사유 | 어제→오늘 순위만 | **[V↓ Q↓ M↓] 팩터별 사유** |
| FnGuide 캐시 | 수동 갱신 | **주간 자동 갱신** (`fnguide_weekly.yml`) |

**투자 근거 자동 생성 (`_get_buy_rationale()`)**:
```python
# 우선순위: 실적 개선(F.PER<PER) > 저평가(PER<10) > 고수익성(ROE>15) > 과매도(RSI<35) > 52주 저점(w52<-30%)
# 해당 없으면 "멀티팩터 상위"
# 최대 2개 사유, ' · ' 구분
```

**수정 파일**:
1. `send_telegram_auto.py` — `<b>` 볼드 헤더, ✅ 마커, `_get_buy_rationale()`, 생존 순위, `parse_mode='HTML'` 전체 적용
2. `ranking_manager.py` — `max_picks: int = 10` → `max_picks: int = 5`
3. `.github/workflows/fnguide_weekly.yml` — **신규** (매주 일요일 03:00 KST, 시총 1000억+ 전종목 캐시 갱신)
4. `refresh_fnguide_cache.py` — **신규** (FnGuide 주간 갱신 스크립트)

---

## 핵심 변경사항 (v14.1 — 고객 친화적 메시지 리디자인)

### 2026-02-10 텔레그램 메시지 톤/아이콘/구조 전면 개선

**배경**: 처음 보는 고객도 종목 선정 흐름, 보유 기간, 매도 기준을 즉시 이해할 수 있도록 메시지 생애주기 중심으로 리디자인.

| 항목 | Before (v14.0) | After (v14.1) |
|------|----------------|---------------|
| 개요 아이콘 | 📋 오늘의 퀀트 리포트 | **📊 퀀트 포트폴리오 — 활용 가이드** |
| 개요 구조 | [종목 선정 과정] [이렇게 활용하세요] | **▸ 종목은 이렇게 선정됩니다 / ▸ 매수·보유·매도 기준** |
| 개요 클로징 | "천천히 들어가고, 빠르게 나옵니다" | **"매일 이 리포트를 확인하시면 됩니다"** + 3일 검증/이탈 설명 |
| 탈락 아이콘 | 🚨 탈락 종목 | **⛔ 탈락 종목 — 매도 검토** |
| 탈락 상세 | (12위 → 이탈) · 섹터 | **어제 12위 → 오늘 67위** (today_rank 표시) |
| 유니버스 이탈 | 미표시 | **어제 N위 → 유니버스 이탈** |
| 매수 구분자 | `\|` | **`·`** (가독성) |
| 매수 순위 | 순위 1→1→2 | **3일순위 1→1→2위** (라벨 명확화) |
| 현금 문구 | 현금 비중 X% | **잔여 현금 X%** |
| 투자주의 | 참고용이며 투자 판단은 본인 책임 | **※ 참고용이며 투자 판단은 본인 책임** |
| 생존 제목 | ✅ 생존 리스트 (Top 50) | **✅ 생존 리스트 — 보유 유지** |
| 생존 안내 | 없다면 탈락 종목을 확인해주세요 | **없다면 '탈락 종목'을 확인하세요** (따옴표로 섹션 연결) |
| 구분선 | 18자 혼용 | **17자 통일** |
| 경고 문구 | 신규 진입 시 유의하세요 | **신규 매수 시 유의하세요** |
| 모듈 docstring | v5.0, 3섹션 | **v5.1, 4개 메시지** |

**수정 파일**:
1. `send_telegram_auto.py` — format_overview(), format_death_list(), format_buy_recommendations(), format_survivors(), 헤더/경고 블록

---

## 핵심 변경사항 (v14.0 — UI 리디자인 + 시장 경고 + 콜드 스타트)

### 2026-02-10 고객 친화적 UI 전면 개편 + 시장 이평선 경고 + 콜드 스타트

**배경**: v5.0 전략 개편 후 텔레그램 메시지 품질 개선
1. **고객 접근성**: 처음 보는 사용자도 활용법을 즉시 이해
2. **시장 경고**: 지수 이평선 상태로 전체 시장 건강 진단
3. **콜드 스타트 안전**: 3일 데이터 미확보 시 채널 전송 차단

| 항목 | Before (v13.0) | After (v14.0) |
|------|----------------|---------------|
| 첫 메시지 | 바로 헤더+종목 | **개요 메시지** (분석 흐름 + 활용 가이드) |
| 헤더 | "퀀트 포트폴리오 v5.0" + 전략 설명 | **날짜 + 지수만** (깔끔) |
| 지수 표시 | 코스피/코스닥 한 줄 | **각각 별도 줄 + 개별 색상** |
| 시장 경고 | 없음 | **MA5/MA20/MA60 + 데드크로스 자동 진단** |
| 매수 추천 | "매수 추천" + 메달 아이콘 | **"매수 후보" + 번호** |
| 순위 변동 | T0:1 T1:1 T2:2 | **순위 1→1→2** (직관적) |
| 라인 이모지 | 💰📊📈 매줄 | **제거** (깔끔) |
| 구분선 | ━━━ 혼용 | **────── 통일** |
| 콜드 스타트 | 채널+개인봇 모두 전송 | **채널 스킵, 개인봇만** |
| 백필 데이터 | state/에 테스트 데이터 보유 | **삭제 (클린 스타트)** |

**시장 이평선 경고 (_calc_market_warnings)**:
```python
# 120일 지수 데이터로 MA5/MA20/MA60 계산
# 감지: 5일선↓, 20일선↓, 60일선↓, 단기DC (MA5<MA20)
# 수준: ⚡주의(1개) / ⚠️경계(2개) / 🚨위험(3개+)
# 양호 시 경고 블록 생략
```

**콜드 스타트 채널 스킵**:
```python
if cold_start:
    # 채널 전송 스킵 (3일 데이터 미확보)
    # 개인봇에만 관망 메시지 전송
    # AI 브리핑 채널 전송도 스킵
```

**수정 파일**:
1. `send_telegram_auto.py` — UI 전면 개편 (개요 메시지, 지수 분리, 이평선 경고, 콜드 스타트 채널 스킵)
2. `telegram_test.yml` — 3일 백필 모드 → 단일 실행 복원
3. `state/` — 백필 랭킹 삭제 (ranking_20260205/06/09.json)

---

## 핵심 변경사항 (v13.0 — Slow In, Fast Out 전면 개편)

### 2026-02-10 v5.0 Slow In, Fast Out 전략 전면 개편

**배경**: 기존 시스템의 3가지 핵심 문제 해결
1. **뒷북치기**: 하루 순위에 올라온 종목 바로 추천 → 다음날 빠지면 손실
2. **가치 함정**: 저평가지만 계속 하락하는 종목 (PER/PBR만으로 판단 불가)
3. **정신적 피로**: 매일 20개 종목 분석하는 직장인의 부담

| 항목 | Before (v4.0) | After (v5.0) |
|------|---------------|--------------|
| 매수 추천 | TOP 10 (당일 순위 기반) | **3일 교집합 Top 30** (최대 10종목) |
| 매도 신호 | 없음 | **Death List** (50위 이탈 즉시 경보) |
| 모멘텀 | 12M - 1M 단순 수익률 | **(12M - 1M) / 변동성** (리스크 조정) |
| 추세 필터 | 없음 | **MA60 필터** (현재가 < 60일선 제외) |
| 상태 관리 | 무상태 | **state/ JSON** (GitHub Actions git commit) |
| 텔레그램 | TOP 20 상세 + TOP 10 추천 | **3섹션**: Death List → 매수 추천 → Survivors |
| 비중 | 섹터 분산 + 순위 기반 | **종목당 15%**, 나머지 현금 |
| Overheat 필터 | RSI 70, 급등 필터 | **제거** (3일 검증이 대체) |
| 섹터 분산 | 강제 분산 | **제거** (순수 점수 기반) |

**새 모듈: ranking_manager.py**
```python
save_ranking(date_str, rankings)     # state/ranking_YYYYMMDD.json 저장
load_ranking(date_str)               # 순위 로드
compute_3day_intersection(t0,t1,t2)  # Slow In: 3일 교집합 (가중 T0×0.5+T1×0.3+T2×0.2)
compute_death_list(today, yesterday) # Fast Out: 50위 이탈 감지
get_survivors(today, threshold=50)   # Top 50 생존 리스트
```

**리스크 조정 모멘텀 (strategy_b_multifactor.py)**
```python
Score = (12M수익률 - 1M수익률) / 12M변동성(연환산)
- 12M수익률 ≤ 0 → 제외 (하락 추세)
- 변동성 하한선 15% (저변동 종목 점수 폭발 방지)
```

**MA60 추세 필터 (create_current_portfolio.py)**
```python
# 4.5단계: 현재가 >= MA60이면 통과, 아니면 제외
# → 가치 함정 원천 차단
```

**콜드 스타트 처리**
- Day 1-2: 순위 데이터 부족 → "관망" 메시지 전송
- Day 3+: 3일 교집합 + Death List 정상 가동

**수정 파일**:
1. `strategy_b_multifactor.py` — 모멘텀 공식 변경 (리스크 조정)
2. `create_current_portfolio.py` — MA60 필터 + 순위 JSON 저장 + sys.argv 날짜 오버라이드
3. `ranking_manager.py` — **신규** (3일 교집합, Death List, 순위 저장/로드)
4. `send_telegram_auto.py` — **전면 개편** (3섹션 구조, AI 브리핑은 추천종목만)
5. `telegram_daily.yml` — cron 06:30, state/ git commit, permissions: write
6. `telegram_test.yml` — state/ git commit, permissions: write

---

## 핵심 변경사항 (v12.0 — 전략 구조 개편 + 유니버스 확대)

### 2026-02-10 거래대금 차등 필터 + 마법공식 사전필터만 + 멀티팩터 100%

**배경**: 삼지전자(시총 3,500억, 거래대금 32억) 같은 우량 중소형주가 일괄 거래대금 50억 필터에 탈락. 하나투어(멀티팩터 1위)가 마법공식 30% 가중에 끌려 통합순위 하락. A와 B의 팩터 중복 문제.

| 항목 | Before (v11.0) | After (v12.0) |
|------|----------------|---------------|
| 거래대금 필터 | 일괄 50억 | **시총 1조+: 50억, 3000억~1조: 20억** |
| 유니버스 규모 | ~454개 | **~617개** (+36%) |
| 사전필터 (A) | 150개, 순위 30% 반영 | **200개, 순위 미반영 (스크리닝만)** |
| 최종순위 | A 30% + B 70% | **B(멀티팩터) 100%** |
| TOP 추천 | TOP 5 | **TOP 10** (섹터 분산 + 위험 플래그 제거) |

**거래대금 차등 필터**:
```python
# 대형주(시총 1조+): 거래대금이 적으면 문제 신호
# 중소형(3000억~1조): 거래대금 낮아도 정상
TRADING_LARGE = 50  # 시총 1조 이상
TRADING_MID = 20    # 시총 3000억 ~ 1조
```

**전략 A→B 분리 근거**:
- 마법공식 이익수익률(EBIT/EV) ≈ 멀티팩터 Value(PER, PBR 등) → 팩터 중복
- 마법공식 ROIC ≈ 멀티팩터 Quality(ROE, GPA, CFO) → 팩터 중복
- A 30% 가중이 하나투어(여행업 선수금→높은 부채→낮은 이익수익률) 같은 업종 특성 종목을 불이익
- 해결: A는 "이익도 못 내는 종목" 걸러내는 사전필터만, 순위는 B가 전담

**검증 결과** (2026-02-09 기준):
- 유니버스: 809 → 거래대금 차등 → 617 → 금융/지주 제외 → 571
- 사전필터: 200개 통과
- 하나투어: **멀티팩터 4위** (이전: 통합 23위에서 밀림 → 이제 상위권)
- 삼지전자: 중소형 20억 기준 통과 → 포트폴리오 포함

**수정 파일**:
1. `create_current_portfolio.py` — 거래대금 차등 필터, 사전필터 200, 통합순위 제거 → 멀티팩터 100%
2. `send_telegram_auto.py` — TOP 10 추천, 전략 설명 업데이트, 10위 아이콘 수정
3. `config_template.py` — PREFILTER_N=200, MIN_TRADING_VALUE 제거
4. `telegram_daily.yml` / `telegram_test.yml` — PREFILTER_N=200, MIN_TRADING_VALUE 제거

---

## 핵심 변경사항 (v11.0 — Forward PER 실적 개선 시그널)

### 2026-02-09 FnGuide 컨센서스 Forward PER → EPS개선도 팩터 추가

**배경**: 기존 시스템은 Trailing PER만 사용 — "과거에 싼 주식"만 찾음. FnGuide Forward PER 데이터(커버리지 ~80%)가 이미 크롤러에 구현되어 있었지만 한 번도 호출되지 않고 있었음.

**핵심 아이디어**: Forward PER < Trailing PER = 실적이 좋아지고 있다는 시그널 → **"싸면서 좋아지고 있는 주식"**을 찾는다.

| 항목 | Before (v10.5) | After (v11.0) |
|------|----------------|---------------|
| Forward PER | 크롤러에만 존재 (미사용) | **파이프라인에 연결, Quality 팩터에 추가** |
| Quality 팩터 | ROE + GPA + CFO (3개) | **ROE + GPA + CFO + EPS개선도 (4개)** |
| EPS개선도 | 없음 | **(Trailing PER - Forward PER) / Trailing PER * 100** |
| 컨센서스 수집 | 없음 | **4.5단계: 150개 종목 FnGuide 컨센서스** |
| 텔레그램 표시 | PER 29.2 | **PER 29.2→5.3** (Forward PER 병기) |
| 소요 시간 | ~35초 | **~120초** (컨센서스 수집 +75초) |

**EPS개선도 계산**:
```python
# 양수 = 실적 개선 (Forward PER이 Trailing보다 낮음)
# 음수 = 실적 악화 (Forward PER이 Trailing보다 높음)
EPS개선도 = (Trailing_PER - Forward_PER) / Trailing_PER * 100

# 예시:
# SK하이닉스: PER 29.2 → Forward 5.3 = +78.6% (대폭 개선)
# 효성: PER 5.67 → Forward 8.0 = -41.1% (실적 악화)
```

**NaN 처리**: Forward PER이 없는 ~20% 종목은 EPS개선도 NaN → `data[quality_factors].mean(axis=1)`이 나머지 3개 팩터(ROE/GPA/CFO) 평균으로 자동 처리 (pandas `skipna=True`).

**파이프라인 변경**:
```
[4단계] OHLCV 로드
[전략 A] 마법공식 사전 필터 → 150종목
[4.5단계] FnGuide 컨센서스 수집 (Forward PER) ← NEW
  → get_consensus_batch(150개, delay=0.5) → forward_per 컬럼
[전략 B] 멀티팩터 스코어링
  → Forward PER 병합 → EPS개선도 계산 → Quality z-score에 추가
[통합순위] A30% + B70% → TOP 30
```

**검증 결과** (2026-02-06 기준):
- Forward PER 확보: 117/150 (78%), 최종 30종목 중 24/30 (80%)
- EPS개선도 계산: 116/150 (Forward PER + Trailing PER 둘 다 양수인 종목)
- TOP 5 실적 개선: SK하이닉스 +78.6%, KT +70.8%, HD한국조선해양 +67.3%
- TOP 3 실적 악화: 효성 -41.1%, 에스엘 -21.1%, 기아 -14.8%

**수정 파일**:
1. `strategy_b_multifactor.py` — `calculate_quality_factors()`에 EPS개선도 추가, 윈저라이징, z-score 계산
2. `create_current_portfolio.py` — 4.5단계 컨센서스 수집, `run_strategy_b_scoring()`에 `consensus_df` 파라미터, forward_per 병합
3. `send_telegram_auto.py` — Forward PER 추출(portfolio_fwd_per), 텔레그램 메시지에 "PER X→Y" 형식 표시

---

## 핵심 변경사항 (v10.5 — AI 브리핑 구분선 안정화)

### 2026-02-09 Gemini [SEP] 의존 제거 → 코드 후처리 구분선

**문제**: Gemini가 `[SEP]` 마커를 불규칙하게 삽입 — 종목 사이 구분선이 랜덤하게 나타나거나 사라짐

| 항목 | Before (v10.4) | After (v10.5) |
|------|----------------|---------------|
| 구분선 생성 | Gemini가 `[SEP]` 마커 삽입 | **코드가 regex로 자동 삽입** |
| 프롬프트 | "종목 사이에 [SEP] 넣어줘" | **"구분선/[SEP] 넣지 마. 코드가 처리"** |
| 감지 방식 | 텍스트에서 `[SEP]` 문자열 치환 | **`<b>종목명(6자리티커)</b>` 패턴 regex** |
| 안정성 | Gemini 응답에 따라 불안정 | **100% 안정 (코드 기반)** |

**구분선 삽입 로직** (`convert_markdown_to_html()`):
```python
# ⚠️ 섹션에서 <b>종목명 (6자리티커)</b> 패턴을 regex로 감지
# 2번째 종목부터 앞에 ───────── 구분선 자동 삽입
idx = result.find('⚠️')
if idx != -1:
    before = result[:idx]
    after = result[idx:]
    count = [0]
    def _sep(m):
        count[0] += 1
        if count[0] <= 1:
            return m.group(0)
        return f'─────────\n{m.group(0)}'
    after = re.sub(r'<b>[^<]+?\(\d{6}\)</b>', _sep, after)
    result = before + after
```

**수정 파일**:
1. `gemini_analysis.py` — 프롬프트에서 [SEP] 지시 제거, `convert_markdown_to_html()` regex 기반 구분선 로직

**교훈**: AI 출력 포맷에 의존하면 불안정 → 가능한 한 코드가 후처리하는 것이 안정적

---

## 핵심 변경사항 (v10.4 — 퀀트 TOP 5 자동 추천)

### 2026-02-09 위험 플래그 연동 + 섹터 분산 자동 선정

**변경**: 퀀트 TOP 30에서 위험 플래그 제외 + 섹터 분산으로 5종목 자동 추천

| 항목 | 내용 |
|------|------|
| 위험 플래그 연동 | AI 브리핑의 `compute_risk_flags()` 재사용 → 위험 종목 자동 제외 |
| 섹터 분산 | `get_broad_sector()` 대분류 (반도체/자동차/바이오/게임/엔터) |
| 진입 전략 | RSI<40 즉시(과매도), <60 즉시, <70 분할, ≥70 대기 |
| 비중 | 25/25/20/15/15% (순위 기반 고정) |
| 전송 | 별도 메시지로 채널+개인봇 전송 |

**선정 로직**:
```
통합순위 1위부터 순회:
  → compute_risk_flags() 있으면 스킵 (SOOP -51% 급락, 제룡전기 -8.7% 급락 등)
  → 같은 대분류 섹터 이미 있으면 스킵 (SK하이닉스 → 반도체 중복)
  → 5종목 채워질 때까지 반복
```

**수정 파일**:
1. `send_telegram_auto.py` — `select_top5()`, `format_recommendation()`, TOP 5 전송 블록 추가

---

## 핵심 변경사항 (v10.3 — AI 브리핑 v3 정량 리스크 스캐너)

### 2026-02-09 해외 프로젝트 구조 적용

**변경**: AI 브리핑을 "정량 리스크 스캐너" 구조로 전면 개편 (eps-momentum-us 참조)

| 항목 | Before (v10.2) | After (v10.3) |
|------|----------------|---------------|
| 위험 감지 | 5개 단순 alert (RSI/52주/전일비) | **6개 정량 플래그** (코드 계산) |
| 프롬프트 | raw 데이터 + alert 전달 | **종목별 인라인 플래그 + 설명 섹션** |
| 출력 포맷 | plain text | **Telegram HTML** (bold, 분리선) |
| 종목 구분 | 없음 | **regex 코드 후처리 구분선** (v10.5에서 [SEP]→regex 전환) |
| ✅ 클린 리스트 | Gemini 생성 (포맷 불안정) | **코드 직접 생성** |
| temperature | 0.3 고정 | **0.2 → 실패시 0.3 재시도** |
| 응답 추출 | response.text 직접 | **extract_text() 헬퍼** |

**6가지 위험 플래그**:
- 🔺 과매수 (RSI≥75) | 📉 52주 급락 (≤-35%) | ⚠️ 전일 급락 (≤-5%)
- 🔺 전일 급등 (≥+8%) | 💰 고평가 (PER>40) | 📊 거래량 폭발 (≥3배)

**수정 파일**:
1. `gemini_analysis.py` — compute_risk_flags(), build_prompt() 재작성, convert_markdown_to_html(), extract_text()
2. `send_telegram_auto.py` — AI 브리핑 parse_mode='HTML', TOP20 종목간 여백 축소

---

## 핵심 변경사항 (v10.2 — 포트폴리오 품질 개선)

### 2026-02-09 유니버스 강화 + 멀티팩터 비중 조정 + AI 브리핑 채널 전송

**문제**: 잡주(제닉 PBR 8.2, 아이티센글로벌 PER 247)가 TOP 10에 진입
**근본 원인**: Quality(ROE) 40%가 Value 40%를 상쇄 → "비싸지만 ROE 높은" 종목이 상위 진입

| 항목 | Before (v3.1) | After (v3.2) |
|------|---------------|--------------|
| 시가총액 하한 | 1000억 | **3000억** |
| 거래대금 하한 | 30억 | **50억** |
| PER 상한 | 없음 | **60** |
| PBR 상한 | 없음 | **10** |
| Value 비중 | 40% | **50%** |
| Quality 비중 | 40% | **30%** |
| Momentum 비중 | 20% | 20% |
| Fallback (V/Q) | 50/50 | **60/40** |
| AI 브리핑 전송 | 개인봇에만 | **채널+개인봇** |

**효과**: 유니버스 ~775개 → ~450개, PER/PBR 필터로 152종목 추가 제거, 잡주 전부 탈락

**수정 파일**:
1. `create_current_portfolio.py` — 유니버스 defaults + 3.6단계 PER/PBR 필터
2. `strategy_b_multifactor.py` — Value 50% / Quality 30% / Momentum 20%
3. `config_template.py` — PER_MAX_LIMIT, PBR_MAX_LIMIT 추가
4. `send_telegram_auto.py` — AI 브리핑 채널+개인봇 전송 + SECTOR_DB 19종목 추가

---

## 핵심 변경사항 (v9.0 — Gemini AI 브리핑)

### 2026-02-08 AI 리스크 스캐너 → AI 브리핑 전환

**교훈: Gemini Search Grounding 한계**

| 시도 | 방식 | 결과 |
|------|------|------|
| 1차 | 30종목 개별 검색 요청 | 5-8개만 실제 검색, 나머지 할루시네이션 |
| 2차 | 5종목씩 배치 | 여전히 일부만 검색 |
| 3차 | temperature 0.2 | 빈 응답 빈번 |
| 4차 | temperature 0.5 | 검색 안 되면 할루시네이션 |
| **최종** | **"검색은 코드가, 분석은 AI가"** | **안정적 작동** |

**근본 원인**: Google Search Grounding은 요청당 5-8개 검색 쿼리만 생성. 30개 종목 개별 검색은 구조적으로 불가능.

**해결 원칙: "검색은 코드가, 분석은 AI가"**

| 역할 | 담당 | 내용 |
|------|------|------|
| 데이터 수집 | 코드 | PER/PBR/ROE/RSI/52주위치/전일비 |
| 주의 신호 감지 | 코드 | RSI ≥80/≤25, 52주 ≤-40%, 전일 ≤-7%/≥10% |
| 시장 동향 | AI (1개 검색) | Google Search 1회 (광범위 쿼리 → 안정적) |
| 데이터 해석 | AI | 섹터 편중, 밸류에이션, 모멘텀 패턴 분석 |

**1. gemini_analysis.py (v2 — 브리핑 모듈)**

| 항목 | Before (리스크 스캐너) | After (AI 브리핑) |
|------|----------------------|-------------------|
| AI 모델 | Gemini 2.5 Flash (temp=0.2) | Gemini 2.5 Flash (**temp=0.3**) |
| 검색 | 30종목 개별 뉴스 검색 | **시장 동향 1회만 검색** |
| 데이터 | AI가 검색으로 수집 | **코드가 구성해서 전달** |
| 주의 감지 | AI 판단 | **코드 기반 (RSI/52주/전일비)** |
| 프롬프트 | 소거법 리스크 스캐너 | **데이터 해석 브리핑** |
| 출력 | 📰시장/🚫주의/📅실적/✅미발견 | **📰시장/⚠️주의/📊특징** |
| 빈 응답 | 미처리 | **재시도 1회 + finish_reason 로그** |
| 전송 대상 | 채널+개인봇 | **채널+개인봇** (v10.2에서 복원) |

**2. 연동 구조**

```
create_current_portfolio.py → portfolio CSV
send_telegram_auto.py → 포트폴리오 메시지 전송 (채널+개인봇)
  → gemini_analysis.run_ai_analysis(None, stock_list)
  → 코드가 데이터 구성 → AI가 해석
  → AI 브리핑 채널+개인봇 전송
```

**3. 종목별 뉴스 제거**

| 항목 | Before | After |
|------|--------|-------|
| Google News RSS | 종목별 크롤링 (30회) | **완전 제거** |
| 센티먼트 분석 | 키워드 기반 (부정확) | **제거** |
| 부분 매칭 문제 | "제닉"→"키토제닉" 오매칭 | **해결 (제거)** |
| 메시지 크기 | 3389자 (분할 필요) | **2838자 (단일)** |

**4. GitHub Actions 연동**

- `GEMINI_API_KEY` GitHub Secret 추가
- `google-genai` pip install 추가
- config.py 생성 시 GEMINI_API_KEY 포함

---

## 핵심 변경사항 (v8.0 — v3.1 전략 아키텍처)

### 2026-02-07 전략 구조 개편 + 가중TTM + 공동순위 제거

**1. A→필터, B→스코어링, A30%+B70% 통합순위**

| 항목 | Before (v3.0) | After (v3.1) |
|------|---------------|--------------|
| Strategy A | 30종목 선정 | **150종목 사전 필터** |
| Strategy B | 30종목 선정 | **150종목 전체 스코어링** |
| 최종 선정 | A∩B 교집합 | **A30%+B70% 통합순위 TOP 30** |
| 출력 | strategy_a/b.csv 분리 | **portfolio_YYYY_MM.csv 통합** |
| TTM | 균등 합산 | **가중TTM (40/30/20/10%)** |
| 텔레그램 | 3개 메시지 (교집합+A+B) | **1~2개 메시지 (TOP 20 상세)** |
| 순위 | `method='average'` (공동순위) | **`method='first'` (고유순위)** |
| pykrx | 미활용 | **PER/PBR/DIV 실시간 우선** |

**2. 가중 TTM (fnguide_crawler.py)**

```python
# 손익계산서/현금흐름표: 최신 분기 가중치 높음
# weights: 1.6(40%), 1.2(30%), 0.8(20%), 0.4(10%) → 합 4.0 (기존 TTM 스케일 유지)
weight_map = {최신: 1.6, 2번째: 1.2, 3번째: 0.8, 4번째: 0.4}
```
→ 브이티 같은 최근 실적 악화 종목이 순위에서 자연스럽게 하락

**3. 뉴스 필터링 + TOP 20 + SECTOR_DB 확장**

- `is_relevant()`: 채용공고, 다종목나열(·×3), 종목명 미포함 뉴스 제외
- TOP 10 → TOP 20 상세 표시, 3800자 초과시 메시지 분할
- SECTOR_DB 40+ 종목 확장 (기타→구체적 업종명)

---

## 핵심 변경사항 (v7.1 코드 정리)

### 2026-02-07 Git 캐시 정리 + DART 제거

**Git 캐시 정리**: 2,261개 제거, fs_fnguide 743개 유지

**DART API 완전 제거**: `dart_api.py` 삭제, config에서 DART_API_KEY 제거

---

## 핵심 변경사항 (v7.0 GitHub Actions 완전 자동화)

### 2026-02-06 GitHub Actions 수정

**문제**: GitHub Actions에서 모듈 누락 및 타임존 문제

| 수정 항목 | 문제 | 해결 |
|----------|------|------|
| 타임존 | UTC로 실행되어 날짜 오류 | **KST 타임존 명시적 처리** |
| 워크플로우 | CSV 생성 단계 누락 | **create_current_portfolio.py 단계 추가** |
| 의존성 | tqdm, scipy 누락 | **pip install에 추가** |
| 파일 누락 | error_handler.py 미커밋 | **GitHub에 추가** |
| 리밸런싱 월 | 3/6/9/12월 (잘못됨) | **4/5/8/11월로 수정** |

**KST 타임존 처리**:
```python
from zoneinfo import ZoneInfo
KST = ZoneInfo('Asia/Seoul')

def get_korea_now():
    return datetime.now(KST)

TODAY = get_korea_now().strftime('%Y%m%d')
BASE_DATE = get_previous_trading_date(TODAY)
```

**GitHub Actions 워크플로우** (telegram_daily.yml):
```yaml
- name: Install dependencies
  run: |
    pip install pykrx pandas numpy requests beautifulsoup4 lxml pyarrow tqdm scipy html5lib google-genai

- name: Generate portfolio (create CSV)
  run: python create_current_portfolio.py

- name: Send Telegram message
  run: python send_telegram_auto.py
```

**데이터 소스**:
- 재무제표: FnGuide 캐시 (Q3 2025 고정)
- 시가총액: pykrx 실시간
- OHLCV: pykrx 실시간

---

## 핵심 변경사항 (v6.5 OHLCV 캐시 로직 개선)

### 2026-02-05 버그 수정

**수정된 파일**: `create_current_portfolio.py`

| 수정 항목 | Before | After |
|----------|--------|-------|
| OHLCV 메서드 | `get_ohlcv_parallel` (없는 메서드) | `get_all_ohlcv` |
| 캐시 검증 | 캐시 있으면 무조건 사용 | **BASE_DATE 데이터 존재 확인** |

**OHLCV 캐시 로직 개선**:
```python
# Before: 캐시 있으면 그냥 사용 (BASE_DATE 데이터 없어도)
if ohlcv_cache_files:
    price_df = pd.read_parquet(ohlcv_cache_file)

# After: BASE_DATE 데이터가 캐시에 있는지 확인
if ohlcv_cache_files:
    price_df = pd.read_parquet(ohlcv_cache_file)
    base_date_dt = pd.Timestamp(datetime.strptime(BASE_DATE, '%Y%m%d'))
    if base_date_dt in price_df.index:
        # 캐시 사용
    else:
        # 새로 수집
```

**효과**:
- 매일 실행 시 BASE_DATE 데이터가 캐시에 없으면 자동으로 새로 수집
- 일관된 결과 보장 (같은 BASE_DATE면 같은 결과)
- GitHub Actions와 로컬 실행 결과 동일

### GitHub Actions 실행 흐름 (v7.0+)

```
1. checkout → 최신 코드 pull
2. create_current_portfolio.py → portfolio_YYYY_MM.csv 생성
3. send_telegram_auto.py → CSV 읽어서 텔레그램 전송
```

**참고**: v7.0부터 GitHub Actions에서 매번 CSV를 새로 생성하므로, CSV 커밋이 불필요.

---

## 핵심 변경사항 (v3.2 진입점수 개선)

### 2026-02-05 텔레그램 메시지 완전 자동화 + 진입점수 개선

**목표**: "좋은 사과를 싸게 사자" - 할인된 종목 우선

| 변경 항목 | Before | After |
|----------|--------|-------|
| 날짜 | 하드코딩 | **자동 감지 (전일 거래일 기준)** |
| 기술지표 | 수동 입력 | **pykrx 실시간 계산** |
| 선정이유 | 수동 작성 | **데이터 기반 자동 생성** |
| 리스크 | 수동 작성 | **지표 기반 자동 생성** |
| 신고가 돌파 | **보너스 +35점** | **중립 (감점 안 함)** |

**신규 모듈**:
- `send_telegram_auto.py` - 완전 자동화 텔레그램 전송

**날짜 로직**:
```
TODAY = 오늘 날짜 (인사용)
BASE_DATE = 전일 거래일 (분석 기준)
→ 장 시작 전 전일 종가 분석하여 당일 매매 전략 수립
```

**뉴스 자동화** (Google News RSS):
```
크롤링 → 필터링 → 정제 → 표시

필터링 규칙 (시세 뉴스 제외):
- "+X% 상승/하락", "VI 발동"
- "상승폭 확대/축소", "하락폭 확대/축소"
- "주가 X월 X일", "X% 상승 마감"
- "주가.*장중", "장중.*주가"

정제 규칙:
- 종목명 + 조사 제거 (도/는/가/이/을/를/의/에)
- 언론사명, [태그] 제거
- 빈 따옴표(''), 연속 특수문자(··) 정리
- 헤드라인 35자 제한

표시 형식:
📰 주요뉴스: 마스크팩 인기에 1년 새 15배 뛴
📰 주요뉴스: ⚠️삼성전자 HBM4 수율 격차 1.5배… (부정적)

자동화 한계:
- 규칙 기반 필터링 (80~90% 정확도)
- 새로운 패턴의 시세 뉴스는 필터 못 함
- 며칠 사용 후 평가 예정
```

**2단계 전략 시스템**:
```
[1단계] 밸류 - 뭘 살까?
• 유니버스: 거래대금 30억↑ (20일 평균)
• 전략A 마법공식 30개 ∩ 전략B 멀티팩터 30개
• 공통종목 선정 (동적으로 변동)

[2단계] 가격 - 언제 살까?
• 진입점수로 정렬 (RSI↓ 52주저점↓ 거래량↑)
```

**진입점수 계산 (100점 만점)** - "싸게 사자" 철학:
```
RSI (40점): 낮을수록 좋음
  - ≤30: 40점 (과매도 - 최고 기회)
  - 31-50: 30점 (양호)
  - 51-70: 20점 (중립)
  - >70 + 신고가돌파: 20점 (감점 안 함)
  - >70 일반: 10점 (과매수 위험)

52주위치 (30점): 할인 클수록 좋음
  - ≤-20%: 30점 (큰 할인)
  - -10~-20%: 25점
  - -5~-10%: 20점
  - 신고가돌파: 15점 (감점 안 함, 보너스도 없음)
  - 기타: 15점

거래량 (20점): 스파이크 확인
  - ≥1.5x: 20점
  - 일반: 10점

기본 (10점): 통과 종목 기본 점수
```

---

## 핵심 변경사항 (v3.0 리팩토링)

### 2026-02-03 대규모 리팩토링

**목표**: 런타임 50분 → 5분 단축

| 변경 항목 | Before | After |
|----------|--------|-------|
| 재무제표 소스 | FnGuide 크롤링 | **FnGuide 캐시** |
| 처리 방식 | 순차 처리 | **ThreadPool 병렬** |
| 에러 처리 | print + 무시 | **Skip & Log 패턴** |
| 거래대금 필터 | 10억원 (당일) | **30억원 (20일 평균)** |
| 총 소요시간 | ~50분 | **~35초 (캐시)** |

**신규 모듈**:
- `error_handler.py` - Skip & Log 에러 처리

**수정 모듈**:
- `fnguide_crawler.py` - 재무제표 캐시 + 가중TTM + 컨센서스
- `data_collector.py` - ThreadPool 병렬 처리 추가
- `create_current_portfolio.py` - 동기 main() 구조

---

## 1. 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────┐
│                         데이터 수집 레이어                            │
├─────────────────────────────────────────────────────────────────────┤
│  pykrx API                        │  FnGuide                          │
│  - 시가총액 (병렬)                 │  - 재무제표 (캐시, 가중TTM)       │
│  - OHLCV (병렬)                   │                                   │
│  - PER/PBR/DIV (실시간)           │                                   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         전략 레이어                                   │
├─────────────────────────────────────────────────────────────────────┤
│  Strategy A (마법공식) → 사전 필터 200종목 (순위 미반영)               │
│  - 이익수익률 (EBIT/EV) + 투하자본수익률 (ROC)                       │
│                                                                      │
│  MA60 추세 필터 → 현재가 < 60일 이동평균 제외 (가치 함정 차단)          │
│                                                                      │
│  Strategy B (멀티팩터) → 200종목 전체 스코어링 → 순위 100%            │
│  - Value 50% (PER/PBR 실시간, PCR, PSR, DIV 실시간)                  │
│  - Quality 30% (ROE, GPA, CFO, EPS개선도)                             │
│  - Momentum 20% ((12M-1M)/변동성, 리스크 조정)                       │
│                                                                      │
│  순위 JSON 저장 → state/ranking_YYYYMMDD.json                        │
│  3일 교집합 (Slow In) → Death List (Fast Out) → Survivors            │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         출력 레이어                                   │
├─────────────────────────────────────────────────────────────────────┤
│  텔레그램 4메시지:              │  AI 브리핑 (Gemini, 추천종목만)         │
│  개요 → 본문(Death+매수후보)  │  state/ git commit (GitHub Actions)     │
│  → 생존리스트 → AI 브리핑     │  콜드스타트: 채널스킵, 개인봇만         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 핵심 모듈 상세

### 2.1 error_handler.py (~315줄)

Skip & Log 패턴 에러 처리

#### 에러 카테고리

```python
class ErrorCategory(Enum):
    NETWORK = "network"           # 네트워크/연결 오류
    API_RATE_LIMIT = "rate_limit" # API 호출 제한
    DATA_NOT_FOUND = "not_found"  # 데이터 없음
    PARSE_ERROR = "parse"         # 파싱 실패
    VALIDATION = "validation"     # 데이터 검증 실패
    TIMEOUT = "timeout"           # 타임아웃
    UNKNOWN = "unknown"           # 기타
```

#### ErrorTracker 클래스

```python
class ErrorTracker:
    def log_error(ticker, category, message, exception=None):
        """에러 기록 + 실패 종목 추적"""

    def log_warning(ticker, message):
        """경고 기록 (복구 가능)"""

    def mark_success(ticker):
        """성공 시 실패 목록에서 제거"""

    def get_failed_tickers() -> List[str]:
        """실패 종목 목록"""

    def get_summary() -> Dict:
        """에러 통계 요약"""

    def save_error_log(path=None) -> Path:
        """JSON 로그 저장"""
```

#### 사용 예시

```python
tracker = ErrorTracker(log_dir=Path("logs"), name="portfolio")

for ticker in tickers:
    try:
        data = get_financial_statement(ticker)
        tracker.mark_success(ticker)
    except Exception as e:
        tracker.log_error(ticker, ErrorCategory.NETWORK, "수집 실패", e)
        continue  # Skip & Log

tracker.print_summary()
tracker.save_error_log()
```

---

### 2.2 fnguide_crawler.py (~490줄)

FnGuide 재무제표 캐시 + 가중TTM + 컨센서스

#### 주요 함수

```python
def get_financial_statement(ticker, use_cache=True):
    """재무제표 캐시 로드 (parquet)"""

def get_all_financial_statements(tickers, use_cache=True):
    """전체 종목 재무제표 캐시 일괄 로드"""

def extract_magic_formula_data(fs_dict, base_date=None, use_ttm=True):
    """재무제표에서 마법공식/멀티팩터 지표 추출 (가중TTM 적용)"""

def get_consensus_data(ticker):
    """Forward EPS/PER 컨센서스 수집 (FnGuide)"""

def get_consensus_batch(tickers, delay=1.0):
    """배치 컨센서스 수집 (동기)"""
```

---

### 2.3 data_collector.py (~340줄)

pykrx API 래퍼 + 병렬 처리

#### 주요 메서드 (DataCollector 클래스)

```python
def get_ticker_list(self, date, market='ALL'):
    """종목코드 목록 조회"""

def get_market_cap(self, date, market='ALL'):
    """시가총액 조회 (KOSPI/KOSDAQ)"""

def get_all_ohlcv(self, tickers, start_date=None, end_date=None):
    """OHLCV 병렬 수집 (ThreadPoolExecutor)"""

def get_market_fundamental_batch(self, date, market='ALL'):
    """pykrx PER/PBR/DIV 일괄 조회 (캐시)"""

def get_krx_sector(self, date):
    """KRX 업종 정보 조회"""

def get_index_ohlcv(self, start_date=None, end_date=None, ticker='1001'):
    """지수 OHLCV 조회"""
```

---

### 2.4 create_current_portfolio.py (~400줄)

포트폴리오 생성 메인 스크립트 (동기)

#### 핵심 함수

```python
def main():
    """메인 실행 함수 (동기)"""
    # 1. 시가총액 수집 (pykrx)
    # 2. 유니버스 필터링 (시총/거래대금/금융업)
    # 3. 재무제표 수집 (FnGuide 캐시, 가중TTM)
    # 4. pykrx 실시간 PER/PBR/DIV
    # 5. OHLCV 수집 (ThreadPool 병렬)
    # 6. 전략 A 사전 필터 → 200종목 (순위 미반영)
    # 7. 전략 B 스코어링 → 200종목 전체
    # 8. 멀티팩터 순위 100% → TOP 30
    # 9. 결과 저장 (CSV + 리포트)

def run_strategy_a_prefilter(magic_df, universe_df, n=150):
    """마법공식 사전 필터"""

def run_strategy_b_scoring(magic_df, price_df, universe_df, fund_df, prefiltered, n=30):
    """멀티팩터 스코어링 (pykrx live PER/PBR/DIV 우선)"""
```

---

### 2.5 gemini_analysis.py (~430줄)

Gemini 2.5 Flash AI 분석 — 리스크 필터 + 최종 추천 멘트

#### 주요 함수

```python
# [1단계] AI 리스크 필터
def compute_risk_flags(stock):
    """종목별 6가지 위험 플래그 계산 (코드 팩트 기반)"""

def build_prompt(stock_list):
    """리스크 프롬프트 — 종목별 인라인 플래그 + 위험 신호 설명"""

def convert_markdown_to_html(text):
    """리스크 마크다운 → 텔레그램 HTML (⚠️ 섹션 regex 구분선)"""

def run_ai_analysis(portfolio_message, stock_list):
    """[2/3] AI 리스크 필터 생성 (Google Search Grounding)"""

# [2단계] 최종 추천 AI 멘트
def build_final_picks_prompt(stock_list, weight_per_stock):
    """최종 추천 프롬프트 — 종목별 날씨아이콘 + 1-2줄 이유"""

def _convert_picks_markdown(text):
    """최종 추천 마크다운 → HTML ([SEP] → 구분선)"""

def run_final_picks_analysis(stock_list, weight_per_stock, base_date):
    """[3/3] 최종 추천 AI 멘트 생성 (검색 없음, temp=0.2)"""

# 공통
def get_gemini_api_key():
    """API 키 로드 (환경변수 → config.py)"""

def extract_text(resp):
    """response.text None일 때 parts에서 직접 추출"""
```

#### 2단계 AI 분석 흐름
```
send_telegram_auto.py
  → all_candidates = 3일교집합 전체 (하드필터 통과)
  → [2/3] run_ai_analysis(all_candidates)  # 리스크 필터 (전체 후보 대상, Google Search)
  → compute_risk_flags → 클린 종목 우선 상위 5개 = picks
  → [3/3] run_final_picks_analysis(picks)  # 종목별 멘트 (검색 없음)
  → format_buy_recommendations(picks, ai_picks_text=...)
```

---

## 3. 데이터 흐름

### 포트폴리오 생성 (create_current_portfolio.py)

```
1. pykrx에서 시가총액 조회
   └─ KOSPI + KOSDAQ = ~2,773개

2. 유니버스 필터링
   ├─ 시가총액 >= 3000억원
   ├─ 거래대금 >= 50억원 (20일 평균)
   └─ 금융/지주 제외 → ~450개

3. 재무제표 수집
   └─ FnGuide 캐시 로드 (parquet)

3.5. pykrx 실시간 펀더멘털 (PER/PBR/DIV)
   └─ get_market_fundamental_batch(BASE_DATE)

4. 가중TTM 계산
   ├─ Flow: 최근 4분기 가중 합산 (40/30/20/10%)
   └─ Stock: 최근 분기 값

5. 전략 A 사전 필터 → 150종목
   └─ 이익수익률 + ROC 순위 합산

3.6. PER/PBR 상한 필터 (PER>60, PBR>10 제외)
   └─ 고평가 잡주 제거 → ~290개

5.5. FnGuide 컨센서스 수집 (Forward PER) → 150종목
   └─ get_consensus_batch() → forward_per, EPS개선도

6. 전략 B 스코어링 → 150종목 전체
   └─ Value*0.5 + Quality*0.3 + Momentum*0.2
   └─ Quality: ROE + GPA + CFO + EPS개선도 (Forward PER 기반)
   └─ PER/PBR/DIV: pykrx 실시간 우선

7. 통합순위 → TOP 30
   └─ 멀티팩터 100% (마법공식은 사전필터만)

8. 결과 저장
   └─ output/portfolio_YYYY_MM.csv (통합)
```

---

## 4. 파일 구조

```
quant_py-main/
├── 핵심 모듈
│   ├── error_handler.py          # Skip & Log 에러 처리
│   ├── fnguide_crawler.py        # FnGuide 재무제표 캐시 + 가중TTM
│   ├── data_collector.py         # pykrx API + 병렬 처리 + 펀더멘털 배치
│   ├── strategy_a_magic.py       # 전략 A: 마법공식 (사전 필터)
│   ├── strategy_b_multifactor.py # 전략 B: 멀티팩터 (pykrx live 우선)
│   └── gemini_analysis.py         # Gemini AI 브리핑 ("검색은 코드가, 분석은 AI가")
│
├── 실행 스크립트
│   ├── create_current_portfolio.py  # 포트폴리오 생성 (A→필터, B→스코어, 통합순위)
│   ├── send_telegram_auto.py        # 텔레그램 자동 전송 (TOP20, AI 브리핑, TOP5 추천)
│   ├── full_backtest.py             # 전체 백테스팅
│   └── generate_report_pdf.py       # PDF 리포트 생성
│
├── 설정
│   ├── config.py                    # API키/텔레그램 (gitignore)
│   └── config_template.py           # 설정 템플릿
│
├── 출력
│   ├── output/                      # portfolio_YYYY_MM.csv (통합)
│   └── backtest_results/            # 백테스트 결과
│
├── 캐시
│   └── data_cache/
│       ├── fs_fnguide_{ticker}.parquet      # 재무제표 (git 추적)
│       ├── fundamental_batch_*.parquet      # pykrx 펀더멘털 (gitignore)
│       ├── all_ohlcv_{start}_{end}.parquet  # OHLCV (gitignore)
│       └── market_cap_ALL_{date}.parquet    # 시가총액 (gitignore)
│
└── 문서
    ├── README.md
    └── SESSION_HANDOFF.md (이 파일)
```

---

## 5. 알려진 제한사항

### 데이터 관련
1. **FnGuide 컨센서스**: 대형주 위주 커버리지 (~60%)
3. **선호주/우선주**: 일부 재무제표 누락 가능

### 전략 관련
1. **섹터 분류 없음**: 업종 중립화 미적용
2. **거래비용**: 0.3% 고정 (슬리피지 미반영)

### 백테스팅 관련
1. **생존 편향**: 상장폐지 종목 미포함
2. **Look-ahead bias**: 재무제표 공시 시차 반영 (45일/90일)
3. **배당 미반영**: 배당 재투자 미구현

---

## 6. 작업 로그

| 날짜 | 주요 작업 | 파일 |
|------|-----------|------|
| 2026-01-30 | 포트폴리오 생성 시스템 구현 | create_current_portfolio.py |
| 2026-01-31 | 일별 모니터링 시스템 구현 | daily_monitor.py |
| 2026-02-01 | 텔레그램 메시지 3분할 | daily_monitor.py |
| 2026-02-02 | 모멘텀 팩터 구현 | strategy_b_multifactor.py |
| 2026-02-03 | v6.4 리팩토링 (Quality+Price 2축) | daily_monitor.py |
| **2026-02-03** | **Skip & Log 에러 처리 도입** | **error_handler.py (NEW)** |
| **2026-02-03** | **Skip & Log 에러 처리** | **error_handler.py (NEW)** |
| **2026-02-03** | **병렬 처리 추가** | **data_collector.py** |
| **2026-02-03** | **main() 구조 전환 (동기)** | **create_current_portfolio.py** |
| **2026-02-03** | **거래대금 필터 30억으로 조정** | **config.py** |
| **2026-02-03** | **문서 전면 업데이트** | **README.md** |
| **2026-02-04** | **20일 평균 거래대금 필터 적용** | **create_current_portfolio.py** |
| **2026-02-05** | **텔레그램 완전 자동화 (send_telegram_auto.py)** | **send_telegram_auto.py (NEW)** |
| **2026-02-05** | **분석 기준일 전일 거래일로 변경** | **send_telegram_auto.py** |
| **2026-02-05** | **진입점수 개선: 신고가 보너스 제거 (싸게 사자 철학)** | **send_telegram_auto.py** |
| **2026-02-05** | **핵심추천 섹션 제거 (순위만 표시)** | **send_telegram_auto.py** |
| **2026-02-05** | **뉴스 자동 크롤링 및 센티먼트 분석 추가** | **send_telegram_auto.py** |
| **2026-02-05** | **뉴스 헤드라인 요약 개선 (시세뉴스 필터링)** | **send_telegram_auto.py** |
| **2026-02-05** | **GitHub Actions 자동화 (매일 06:00 KST)** | **.github/workflows/telegram_daily.yml (NEW)** |
| **2026-02-05** | **텔레그램 공개채널 연동 (kr_dailyquant)** | **config.py, send_telegram_auto.py** |
| **2026-02-05** | **채널/봇 이중 전송 로직 구현** | **send_telegram_auto.py** |
| **2026-02-05** | **OHLCV 캐시 검증 로직 추가 (BASE_DATE 확인)** | **create_current_portfolio.py** |
| **2026-02-05** | **CSV 파일 커밋 필수 문서화** | **SESSION_HANDOFF.md** |
| **2026-02-06** | **KST 타임존 명시적 처리 추가** | **create_current_portfolio.py, send_telegram_auto.py** |
| **2026-02-06** | **GitHub Actions에 포트폴리오 생성 단계 추가** | **.github/workflows/telegram_daily.yml** |
| **2026-02-06** | **GitHub Actions 의존성 추가 (tqdm, scipy)** | **.github/workflows/telegram_daily.yml** |
| **2026-02-06** | **error_handler.py 누락 파일 커밋** | **error_handler.py** |
| **2026-02-06** | **리밸런싱 권장 월 수정 (4/5/8/11월)** | **send_telegram_auto.py** |
| **2026-02-07** | **Git 캐시 정리 (2,261개 제거, fs_fnguide 743개 유지)** | **.gitignore** |
| **2026-02-07** | **DART API 완전 제거 (dart_api.py 삭제)** | **dart_api.py, config.py, README.md** |
| **2026-02-07** | **데이터 최신성 문제 분석 (Strategy A 75%, B 85% 정적)** | **분석 결과 문서화** |
| **2026-02-07** | **v3.1: A→필터(150), B→스코어링, A30%+B70% 통합순위** | **create_current_portfolio.py** |
| **2026-02-07** | **pykrx 실시간 PER/PBR/DIV 우선 사용** | **strategy_b_multifactor.py, data_collector.py** |
| **2026-02-07** | **가중TTM 적용 (40/30/20/10%)** | **fnguide_crawler.py** |
| **2026-02-07** | **TOP20 상세 + 뉴스 필터링 + SECTOR_DB 확장** | **send_telegram_auto.py** |
| **2026-02-07** | **공동순위 제거 (method='first')** | **strategy_a/b, create_current_portfolio.py** |
| **2026-02-07** | **msg2(전체30간략) 삭제 → 1~2개 메시지만** | **send_telegram_auto.py** |
| **2026-02-08** | **EBIT 수정: EBT→영업이익 사용** | **strategy_a_magic.py** |
| **2026-02-08** | **IC 수정: 비유동자산만 (이미 순액)** | **strategy_a_magic.py** |
| **2026-02-08** | **가중TTM 정규화: <4분기시 weights scale** | **fnguide_crawler.py** |
| **2026-02-08** | **Z-Score: Winsorizing(1%/99%), std=0 가드** | **strategy_b_multifactor.py** |
| **2026-02-08** | **async/await 완전 제거 (동기화)** | **create_current_portfolio.py** |
| **2026-02-08** | **모듈 구조화: main() 함수화** | **send_telegram_auto.py** |
| **2026-02-08** | **bare except → except Exception: 통일** | **전체 파일** |
| **2026-02-08** | **불필요 파일 삭제 (utils.py, backtest_main.py 등 7개)** | **프로젝트 정리** |
| **2026-02-08** | **dead code 제거 (async decorator, prepare_data 함수)** | **error_handler.py, strategy_a_magic.py** |
| **2026-02-08** | **문서 현행화 (README.md, SESSION_HANDOFF.md)** | **MD 파일** |
| **2026-02-08** | **Gemini AI 리스크 스캐너 구현 (Google Search Grounding)** | **gemini_analysis.py (NEW)** |
| **2026-02-08** | **send_telegram_auto에 AI 분석 통합 (포트폴리오→Gemini→전송)** | **send_telegram_auto.py** |
| **2026-02-08** | **GitHub Actions에 Gemini 연동 (secret + google-genai)** | **telegram_daily.yml, config_template.py** |
| **2026-02-08** | **종목별 뉴스 크롤링 제거 (RSS 30회 → 0, 부분매칭 문제 해결)** | **send_telegram_auto.py** |
| **2026-02-08** | **AI 리스크 스캐너 → AI 브리핑 전환 ("검색은 코드가, 분석은 AI가")** | **gemini_analysis.py** |
| **2026-02-08** | **AI 브리핑 개인봇에만 전송 (채널 제외)** | **send_telegram_auto.py** |
| **2026-02-09** | **v3.2: 유니버스 강화 (시총3000억, 거래50억, PER≤60, PBR≤10)** | **create_current_portfolio.py** |
| **2026-02-09** | **멀티팩터 비중 조정 (Value50/Quality30/Momentum20)** | **strategy_b_multifactor.py** |
| **2026-02-09** | **AI 브리핑 채널+개인봇 전송 복원** | **send_telegram_auto.py** |
| **2026-02-09** | **SECTOR_DB 19종목 추가 (기타→구체적 업종명)** | **send_telegram_auto.py** |
| **2026-02-09** | **AI 브리핑 v3: 6가지 정량 리스크 플래그 + Telegram HTML** | **gemini_analysis.py** |
| **2026-02-09** | **AI 브리핑 parse_mode='HTML' + [SEP] 분리선** | **send_telegram_auto.py** |
| **2026-02-09** | **TOP20 종목간 빈 줄 제거 (여백 축소)** | **send_telegram_auto.py** |
| **2026-02-09** | **퀀트 TOP 5 자동 추천 (위험 플래그 제외 + 섹터 분산)** | **send_telegram_auto.py** |
| **2026-02-09** | **AI 브리핑 구분선 안정화: Gemini [SEP] 의존 제거 → regex 코드 후처리** | **gemini_analysis.py** |
| **2026-02-09** | **Forward PER 실적 개선 시그널: FnGuide 컨센서스 수집 파이프라인 연결** | **create_current_portfolio.py** |
| **2026-02-09** | **EPS개선도 팩터 추가: Quality에 (Trailing-Forward)/Trailing*100** | **strategy_b_multifactor.py** |
| **2026-02-09** | **텔레그램 Forward PER 표시: "PER 29.2→5.3" 형식** | **send_telegram_auto.py** |
| **2026-02-10** | **거래대금 차등 필터: 대형50억/중소형20억 (유니버스 454→617)** | **create_current_portfolio.py** |
| **2026-02-10** | **전략 A 순위 반영 제거 → 사전필터만 (200개)** | **create_current_portfolio.py** |
| **2026-02-10** | **최종순위: 멀티팩터 100% (A30%+B70% 통합 폐지)** | **create_current_portfolio.py** |
| **2026-02-10** | **TOP 5 → TOP 10 추천 (섹터 분산 + 위험 플래그 제거)** | **send_telegram_auto.py** |
| **2026-02-10** | **v5.0: Slow In, Fast Out 전략 전면 개편** | **전체** |
| **2026-02-10** | **모멘텀: (12M-1M)/변동성 리스크 조정, 12M≤0 제외** | **strategy_b_multifactor.py** |
| **2026-02-10** | **MA60 추세 필터: 현재가 < MA60 종목 원천 차단** | **create_current_portfolio.py** |
| **2026-02-10** | **ranking_manager.py 신규: 3일 교집합 + Death List + 순위 저장** | **ranking_manager.py (NEW)** |
| **2026-02-10** | **텔레그램 3섹션: Death List → 매수 추천 → Survivors** | **send_telegram_auto.py** |
| **2026-02-10** | **state/ 디렉토리: 일일 순위 JSON 저장 + GitHub Actions git commit** | **state/, telegram_*.yml** |
| **2026-02-10** | **Overheat 필터/섹터 분산/TOP 추천 제거 (3일 교집합이 대체)** | **send_telegram_auto.py** |
| **2026-02-10** | **종목당 비중 20% 전액 투자 (15%→20%)** | **send_telegram_auto.py** |
| **2026-02-10** | **cron 06:00→06:30 KST, permissions: contents: write** | **telegram_daily.yml** |
| **2026-02-10** | **sys.argv 날짜 오버라이드 + 캐시 truncation (백필용)** | **create_current_portfolio.py** |
| **2026-02-10** | **시장 이평선 경고: MA5/MA20/MA60 + 데드크로스 자동 진단** | **send_telegram_auto.py** |
| **2026-02-10** | **UI 전면 개편: 개요 메시지, 지수 분리, 번호 순서, 이모지 정리** | **send_telegram_auto.py** |
| **2026-02-10** | **콜드 스타트 시 채널 전송 스킵 (개인봇에만 전송)** | **send_telegram_auto.py** |
| **2026-02-10** | **백필 랭킹 삭제 — 클린 콜드 스타트** | **state/** |
| **2026-02-10** | **telegram_test.yml: 3일 백필 → 단일 실행 복원** | **telegram_test.yml** |
| **2026-02-10** | **v14.1: 고객 친화적 메시지 리디자인 (아이콘/톤/구조 전면 개선)** | **send_telegram_auto.py** |
| **2026-02-10** | **v15.0: HTML 볼드 + ✅ 마커 + 한 줄 투자 근거 + 생존 순위** | **send_telegram_auto.py** |
| **2026-02-10** | **max_picks 10→5: 고확신 종목 집중** | **ranking_manager.py** |
| **2026-02-10** | **Death List 팩터별 하락 사유 [V↓ Q↓ M↓]** | **ranking_manager.py** |
| **2026-02-10** | **FnGuide 주간 캐시 자동 갱신 (매주 일요일 03:00 KST)** | **fnguide_weekly.yml, refresh_fnguide_cache.py** |

| **2026-02-11** | **v8.1: 텔레그램 4메시지 스토리텔링 구조 전면 개편** | **send_telegram_auto.py** |
| **2026-02-11** | **Top 30 상태별 그룹핑 (✅3일검증/⏳내일검증/🆕신규진입)** | **send_telegram_auto.py** |
| **2026-02-11** | **AI 리스크 필터 이름 변경 + 별도 메시지 분리** | **send_telegram_auto.py, gemini_analysis.py** |
| **2026-02-11** | **최종 추천 AI 멘트: Gemini가 종목별 날씨아이콘+자연어 설명 생성** | **gemini_analysis.py** |
| **2026-02-11** | **최종 추천 퍼널 경로 + 비중 한눈에 보기 추가** | **send_telegram_auto.py** |
| **2026-02-11** | **메시지 간 플로우 큐 (👉 다음: ...) 추가** | **send_telegram_auto.py** |
| **2026-02-11** | **리스크 플래그 정리: 52주급락/PER>40 제거, RSI 75→80 완화 (모델 충돌 해소)** | **gemini_analysis.py** |
| **2026-02-11** | **이탈 종목 순위 변동 표시: 어제→현재 순위 (rankings_t0 전체 데이터 활용)** | **send_telegram_auto.py, test_ui_preview.py** |
| **2026-02-11** | **급락 하드 필터: 전일 -5% 종목 제외 + 다음 가중순위로 대체 (max_picks=30)** | **send_telegram_auto.py** |
| **2026-02-11** | **✅ 3일 검증: 가중순위 순 정렬 + 3일 궤적 표시 (1→1→1)** | **send_telegram_auto.py, test_ui_preview.py** |
| **2026-02-11** | **⏳ 내일 검증: 2일 궤적 표시 (8→14)** | **send_telegram_auto.py, test_ui_preview.py** |
| **2026-02-11** | **Gemini 프롬프트: 순위 궤적 (순위 X→Y→Z) 반영** | **gemini_analysis.py** |
| **2026-02-11** | **최종 추천: 급락 제외 종목 안내 (skipped 파라미터)** | **send_telegram_auto.py** |
| **2026-02-11** | **test_ui_preview: 실제 2/11 데이터로 전면 갱신** | **test_ui_preview.py** |
| **2026-02-12** | **최종 추천 구분선 간격 축소 + 비중 줄바꿈** | **gemini_analysis.py, send_telegram_auto.py** |
| **2026-02-12** | **3일 랭킹 동일 환경 재계산 (OHLCV 캐시 통일)** | **state/ranking_*.json** |
| **2026-02-12** | **save_ranking path 변수 누락 복구** | **ranking_manager.py** |
| **2026-02-13** | **AI 리스크 필터 전체 후보 대상 확대 (5개→전원)** | **send_telegram_auto.py** |
| **2026-02-13** | **picks 선정: 클린 종목 우선 + 플래그 종목 후순위** | **send_telegram_auto.py** |
| **2026-02-13** | **워크플로우 git stash 추가 (pull --rebase 실패 방지)** | **.github/workflows/telegram_daily.yml** |
| **2026-02-13** | **주도 업종 라벨/데이터 줄바꿈 분리** | **send_telegram_auto.py** |
| **2026-02-13** | **~~순위 데이터 보호~~ → 제거 (항상 덮어쓰기, 테스트는 워크플로우 분리)** | **ranking_manager.py, create_current_portfolio.py** |
| **2026-02-13** | **가이드 신호등 설명에 지표 라벨 추가: 🏦신용(HY) · 🇰🇷한국(BBB-) · ⚡변동성(VIX)** | **send_telegram_auto.py** |

---

**문서 버전**: 18.1
**최종 업데이트**: 2026-02-13
