# 2026년 1월 포트폴리오 시스템 업데이트

## 개요
2026년 1월 포트폴리오 생성 시스템에 TTM(Trailing Twelve Months) 방식과 자본잠식 필터를 추가하여 더 정확하고 최신의 재무 데이터를 기반으로 종목을 선정하도록 개선하였습니다.

---

## 주요 변경 사항

### 1. TTM (최근 4분기 합산) 방식 도입

#### 문제점
- 기존: 연간 재무제표만 사용 (90일 공시 시차)
- 2026년 1월 기준 포트폴리오가 2024년 12월 31일 데이터를 사용하는 문제 발생

#### 해결책
- 분기 재무제표를 활용한 TTM 방식 구현
- 손익계산서/현금흐름표: 최근 4분기 합산 (Flow 항목)
- 재무상태표: 최근 분기 스냅샷 (Stock 항목)
- 공시 시차: 45일 (분기), 90일 (연간)

#### 변경 파일
- `fnguide_crawler.py`: `extract_magic_formula_data()` 함수에 `use_ttm` 파라미터 추가
- `create_current_portfolio.py`: TTM 방식 활성화

#### 코드 변경 (fnguide_crawler.py)
```python
def extract_magic_formula_data(fs_dict, base_date=None, use_ttm=True):
    # 손익계산서/현금흐름표 항목 (4분기 합산 대상)
    flow_accounts = [
        '당기순이익', '법인세비용', '세전계속사업이익',
        '매출액', '매출총이익', '영업이익',
        '영업활동으로인한현금흐름', '감가상각비'
    ]

    # 재무상태표 항목 (최근 분기 값 사용 - 스냅샷)
    stock_accounts = [
        '자산', '부채', '유동부채', '유동자산', '비유동자산',
        '현금및현금성자산', '자본'
    ]
```

---

### 2. 자본잠식 종목 필터 추가

#### 문제점
- 자본잠식 종목(자본 <= 0)이 PBR 계산 시 이상치 발생
- 전략 B에서 넥스트칩, DXVX 등 자본잠식 종목이 상위권에 선정되는 문제

#### 해결책
- `자본 <= 0` 인 종목 자동 제외
- 재무 건전성이 확보된 종목만 선정

#### 변경 파일
- `create_current_portfolio.py`: 자본잠식 필터 추가

#### 코드 변경
```python
# 자본잠식 종목 필터링 (자본 <= 0 제외)
if '자본' in magic_df.columns:
    before_count = len(magic_df)
    magic_df = magic_df[magic_df['자본'] > 0].copy()
    filtered_count = before_count - len(magic_df)
    print(f"자본잠식 종목 제외: {filtered_count}개 제외 → {len(magic_df)}개 종목 남음")
```

---

## 최종 포트폴리오 결과 (2026년 1월)

### 기준 정보
- **기준일**: 2026-01-29
- **재무데이터 기준일**: 2025-09-30 (TTM)
- **유니버스**: 668개 종목 (시가총액 1000억+, 거래대금 50억+, 금융/지주사 제외)

### 전략 A - 마법공식 (상위 10종목)

| 순위 | 종목명 | 이익수익률 | ROIC |
|------|--------|-----------|------|
| 1 | 브이티 | 15.6% | 44.9% |
| 2 | 제닉 | 13.0% | 54.0% |
| 3 | 티앤엘 | 13.8% | 29.9% |
| 4 | 휴메딕스 | 15.4% | 26.5% |
| 5 | F&F | 14.8% | 25.6% |
| 6 | 제룡전기 | 10.7% | 33.3% |
| 7 | SOOP | 11.5% | 27.8% |
| 8 | JYP Ent. | 8.8% | 38.2% |
| 9 | SK스퀘어 | 10.3% | 28.1% |
| 10 | 크래프톤 | 12.5% | 21.3% |

### 전략 B - 멀티팩터 (상위 10종목)

| 순위 | 종목명 | 밸류점수 | 퀄리티점수 |
|------|--------|---------|-----------|
| 1 | 에이피알 | -1.56 | 4.67 |
| 2 | 플리토 | -0.31 | 3.07 |
| 3 | 달바글로벌 | -0.44 | 3.09 |
| 4 | 감성코퍼레이션 | 0.23 | 2.31 |
| 5 | 한화비전 | 2.42 | 0.05 |
| 6 | 글로벌텍스프리 | 0.37 | 1.95 |
| 7 | 카페24 | 0.30 | 2.02 |
| 8 | 데브시스터즈 | 0.34 | 1.95 |
| 9 | 제닉 | 0.29 | 1.92 |
| 10 | 브이티 | 0.34 | 1.86 |

### 공통 종목 (8개)
브이티, 제닉, 티앤엘, 제룡전기, SOOP, 하나투어, 동성화인텍, 글로벌텍스프리

### KOSPI/KOSDAQ 분포
- **전략 A**: KOSPI 10개(33%), KOSDAQ 20개(67%)
- **전략 B**: KOSPI 7개(23%), KOSDAQ 23개(77%)

---

## 캐시 파일 재구축

### 문제
- 기존 캐시 파일 86.6% (1,092개)가 "Repetition level histogram size mismatch" 오류로 손상

### 해결
- 손상된 캐시 파일 전체 삭제
- FnGuide에서 668개 종목 재크롤링 (약 28분 소요)
- 657개 종목 성공적으로 수집

---

## 파일 구조

```
quant_py-main/
├── fnguide_crawler.py          # TTM 로직 추가
├── create_current_portfolio.py # 자본잠식 필터 추가
├── output/
│   ├── portfolio_2026_01_strategy_a.csv
│   ├── portfolio_2026_01_strategy_b.csv
│   └── portfolio_2026_01_report.txt
└── data_cache/
    └── fs_fnguide_*.parquet    # 재무제표 캐시
```

---

## 향후 개선 사항

1. **DART API 통합** (Task #8): FnGuide 크롤링을 DART Open API로 대체
2. **생존 편향 제거** (Task #9): 상장폐지 종목 데이터베이스 구축
3. **섹터 균형 옵션**: KOSPI/KOSDAQ 비율 조정 기능 추가

---

## v1.1 업데이트 (2026-01-31)

### 일별 모니터링 시스템 추가

#### 신규 파일
- `daily_monitor.py`: 일별 진입 타이밍 분석 스크립트
- `config.py`: 텔레그램 설정 (gitignore 처리)
- `config_template.py`: 설정 템플릿
- `daily_reports/`: 일별 분석 결과 저장 폴더

#### 진입 점수 시스템
| 지표 | 가중치 | 설명 |
|------|--------|------|
| RSI | 25% | 과매도 구간(≤30) 탐지 |
| 52주 위치 | 25% | 연간 저점 근접 여부 |
| 볼린저밴드 | 20% | 단기 과매도 탐지 |
| 이동평균 이격도 | 20% | 60일선 대비 저평가 |
| 거래량 신호 | 10% | 평균 대비 거래량 |

#### 진입 등급
- 🟢 **매수 적기**: 진입점수 ≥ 0.6
- 🟡 **관망**: 0.3 ≤ 진입점수 < 0.6
- 🔴 **대기**: 진입점수 < 0.3

#### 기능
1. **기술적 지표 분석**: RSI, 볼린저밴드, 이격도, 52주 위치
2. **실시간 밸류에이션**: PER, PBR 실시간 계산
3. **텔레그램 알림**: 매수 적기 종목 자동 알림 (상세 근거 포함)
4. **Git 자동화**: 일별 리포트 자동 커밋/푸시

#### 2026-01-30 모니터링 결과
- 🟢 매수 적기: 1개 (제닉 - 진입점수 0.78)
- 🟡 관망: 15개
- 🔴 대기: 19개

### PDF 리포트 생성
- `generate_report_pdf.py`: PDF 리포트 생성 스크립트
- `Quant_Portfolio_Report_2026Q1.pdf`: 프로젝트 및 포트폴리오 설명 문서

---

## v1.2 업데이트 (2026-02-01)

### 텔레그램 알림 시스템 전면 개선

#### 메시지 3분할 구조
기존 단일 메시지에서 3개 메시지로 분리하여 가독성 향상:

| 메시지 | 내용 | 종목 표시 |
|--------|------|-----------|
| **메시지 1** | 전략 설명 + 매수 추천 | 매수 적기 종목 상세 |
| **메시지 2** | 관망 종목 | 전체 표시 (생략 없음) |
| **메시지 3** | 과열 종목 | 전체 표시 (생략 없음) |

#### 종목별 상세 근거 시스템
각 종목에 대해 선정/관망/과열 이유를 자동 생성:

**매수 추천 근거 (`get_buy_reason()`)**:
- PER 저평가 (< 8: 초저평가, < 12: 저평가)
- 52주 고점 대비 급락 (≤ -50%: 급락, ≤ -30%: 조정)
- RSI 과매도 (≤ 30: 과매도, ≤ 45: 저점권)

**관망 근거 (`get_watch_reason()`)**:
- RSI ≥ 60: 단기 과열
- 52주 고점 대비 > -20%: 고점 근접
- 볼린저밴드 위치 > 0.7: 단기 과열

**과열 근거 (`get_hot_reason()`)**:
- RSI ≥ 80: 극과열, ≥ 70: 과매수
- 52주 고점 대비 ≥ -5%: 신고가, ≥ -15%: 고점 근접
- 60일선 이격도 ≥ +20%: 괴리

#### 신규/수정 함수
```python
# daily_monitor.py 신규 함수
def get_buy_reason(r)      # 매수 추천 근거 생성
def get_watch_reason(r)    # 관망 근거 생성
def get_hot_reason(r)      # 과열 근거 생성
def send_single_telegram(msg)  # 단일 메시지 발송
def send_telegram_message_full(buy, watch, wait, latest_date)  # 3분할 발송
```

#### 메시지 예시
```
📊 퀀트 포트폴리오 일일 리포트
📅 2026.02.01
━━━━━━━━━━━━━━━━━━━━━━━━━

📋 투자 전략
• 전략A(마법공식): 이익수익률+자본효율 높은 저평가주
• 전략B(멀티팩터): 가치+품질+모멘텀 종합 상위주

📈 포트폴리오 구성 (총 35개)
• 전략A 20개 / 전략B 20개
• 공통선정(A+B) 5개
```

---

## v1.3 업데이트 (2026-02-02)

### 모멘텀 팩터 완전 구현

#### 문제점
- 전략 B(멀티팩터)에서 모멘텀 팩터가 미구현 상태 (가중치 50%/50%/0%)
- `price_df=None`으로 실행되어 모멘텀 점수가 모두 0으로 표시

#### 해결책
- 12개월 수익률 (최근 1개월 제외) 기반 모멘텀 계산 구현
- 전체 유니버스 종목에 대해 가격 데이터 수집 (450일)
- 모멘텀 데이터 없는 종목 자동 제외

#### 변경 파일
- `strategy_b_multifactor.py`: 모멘텀 계산 로직 수정
- `create_current_portfolio.py`: 전체 유니버스 가격 데이터 수집

#### 코드 변경 (strategy_b_multifactor.py)
```python
# 모멘텀 계산 (12개월 수익률, 최근 1개월 제외)
lookback_days = 12 * 21  # 252 거래일
skip_days = 1 * 21  # 21 거래일
min_required = lookback_days + skip_days + 1

for ticker in data['종목코드']:
    if ticker in price_df.columns:
        prices = price_df[ticker].dropna()
        if len(prices) >= min_required:
            end_price = prices.iloc[-(skip_days + 1)]
            start_price = prices.iloc[-min_required]
            momentum = (end_price / start_price - 1) * 100

# 모멘텀 없는 종목 제외
if momentum_factors:
    data = data[data['모멘텀_점수'].notna()].copy()
    print(f"모멘텀 데이터 없는 종목 제외: {excluded}개 → {len(data)}개 남음")

# 가중치: Value 40% + Quality 40% + Momentum 20%
data['멀티팩터_점수'] = (data['밸류_점수'] * 0.4 +
                        data['퀄리티_점수'] * 0.4 +
                        data['모멘텀_점수'] * 0.2)
```

#### 결과
- 모멘텀 계산: **606/653개 종목** 매칭 성공
- 47개 종목 (모멘텀 데이터 없음) 자동 제외
- 새로운 TOP 종목: 동양고속(모멘텀 6.96), 로보티즈(모멘텀 7.80), 삼현(모멘텀 4.28) 등

---

## v6.4 업데이트 (2026-02-03)

### 일별 모니터링 v6.4 전면 리팩토링

#### 핵심 변경: Quality(맛) + Price(값) 2축 점수 체계

**기존 문제점**:
- 단일 진입점수(0~1)로 분류 → 다양한 투자 스타일 반영 불가
- RSI 70+ = 무조건 감점 → 모멘텀 플레이 종목 놓침
- "왜 사야 하는지" 논리 불명확

**해결책**:
| 점수 | 구성 요소 | 설명 |
|------|----------|------|
| **맛(Quality)** | 전략등급 + PER + ROE + 회복여력 + 정배열 | 펀더멘털 매력도 (0~100) |
| **값(Price)** | RSI + BB위치 + 거래량 + 이격도 + 52주위치 | 진입 타이밍 점수 (0~100) |

#### 4분류 시스템

| 분류 | 이모지 | 조건 | 매매 방향 |
|------|--------|------|----------|
| **STRONG_MOMENTUM** | 🚀 | 신고가 + 거래량 + RSI 70-80 | 추세 매수 |
| **DIP_BUYING** | 🛡️ | 급락 + 지지선 + RSI 30-50 | 저점 매수 |
| **WAIT_OBSERVE** | 🟡 | 양호하나 타이밍 대기 | 관망 |
| **NO_ENTRY** | 🚫 | 버블/과열/저품질 | 진입 금지 |

#### RSI 70-80 "좋은 과열" 인정
- 기존: RSI 70 이상 = 자동 감점 (모멘텀 종목 놓침)
- 변경: RSI 70-80 + 거래량 증가 = STRONG_MOMENTUM으로 분류 (추세 추종)

#### TOP 3 + 한줄 결론 자동 생성
```python
# 결론 예시
"가는 말이 더 간다. 눌림 없는 강력한 모멘텀"  # 모멘텀 종목
"잃기 힘든 자리. 가격 메리트 극대화 구간"    # 저평가 종목
"좋은 회사지만 지금 사기엔 애매함"           # 관망 종목
```

#### 텔레그램 v6.4 포맷
```
📊 퀀트 포트폴리오 v6.4
📅 2026.02.03
━━━━━━━━━━━━━━━━━━━━━━━━━

📈 시장 현황
• KOSPI: 2,850 🔺0.3%
• KOSDAQ: 870 🔻0.5%

🏆 TODAY'S TOP 3

1️⃣ 🚀 삼성전자 (005930)
   맛: 85점 | 값: 78점
   → 52주 신고가 돌파 + 거래량 2.5배
   💡 가는 말이 더 간다. 눌림 없는 강력한 모멘텀
```

#### 변경 파일
- `daily_monitor.py`: 전면 리팩토링 (1,288줄)
  - `calculate_quality_score()`: 펀더멘털 점수
  - `calculate_price_score()`: 진입타이밍 점수
  - `classify_stock_v64()`: 4분류 로직
  - `generate_reasoning()`: 한줄 근거 생성
  - `generate_conclusion()`: 투자 결론 생성
  - `send_telegram_v64()`: 새 메시지 포맷

---

### 전략 C: Forward EPS 하이브리드 구현

#### 개요
기존 KOSDAQ 성장주 전략 → **Forward EPS 기반 하이브리드 전략**으로 교체

#### 전략 구성
| 필터 | 조건 | 비중 |
|------|------|------|
| **Growth** | Forward EPS > 0 (흑자 예상) | 40% |
| **Safety** | 부채비율 < 200%, 이자보상배율 > 1 | 25% |
| **Value** | Forward PER < 20 | 20% |
| **Momentum** | 60일 가격 모멘텀 | 15% |

#### 데이터 소스
- FnGuide 컨센서스: `comp.fnguide.com/SVO2/ASP/SVD_Main.asp`
- Forward EPS/PER, 목표주가, 애널리스트 수

#### 변경 파일
- `strategy_c_forward_eps.py`: 신규 생성
- `strategy_c_kosdaq_growth_backup.py`: 기존 전략 백업
- `fnguide_crawler.py`: 컨센서스 크롤러 추가
  - `get_consensus_data()`: 단일 종목 컨센서스
  - `get_consensus_batch()`: 일괄 수집

---

### 파일 구조 변경

```
quant_py-main/
├── daily_monitor.py              # v6.4 리팩토링
├── strategy_c_forward_eps.py     # 신규: Forward EPS 하이브리드
├── strategy_c_kosdaq_growth_backup.py  # 백업
├── fnguide_crawler.py            # 컨센서스 크롤러 추가
└── output/
    └── portfolio_2026_01_strategy_c.csv  # 전략 C 포트폴리오
```

---

## v1.4 검토 → v6.4 구현 완료 (2026-02-03)

### Forward EPS 컨센서스 데이터 수집 가능성 확인

#### 배경
- 사용자가 "Korea Hybrid Strategy" 제안 (EPS 모멘텀 + 섹터 상대평가)
- 초기 판단: Forward EPS 데이터 무료 소스 없음 → 구현 불가
- 재검토: FnGuide 무료 페이지에서 컨센서스 데이터 확인

#### 테스트 결과

**데이터 소스**: `comp.fnguide.com/SVO2/ASP/SVD_Main.asp`

| 종목 | 크기 | Forward EPS | Forward PER | 애널리스트 수 |
|------|------|-------------|-------------|--------------|
| 삼성전자 | 대형 | 20,072원 | 8.0배 | 25명 |
| 브이티 | 중형 | 1,716원 | 12.0배 | 2명 |
| SAMG엔터 | 소형 | 2,987원 | 12.4배 | 6명 |

**핵심 발견**: 소형주(SAMG엔터)도 컨센서스 커버리지 존재!

#### 신규 테스트 파일
- `test_consensus_crawl.py`: FnGuide 컨센서스 크롤링 PoC

#### 향후 계획
1. 668개 유니버스 커버리지 테스트
2. 기존 전략 유지 + 신규 전략 C (Hybrid) 추가 검토
3. Safety Filter (부채비율, 이자보상배율) 즉시 적용 가능

---

## 작성일
2026-02-03 (v6.4 업데이트)
