# 2026년 1월 포트폴리오 시스템 업데이트

## 개요
2026년 1월 포트폴리오 생성 시스템에 TTM(Trailing Twelve Months) 방식과 자본잠식 필터를 추가하여 더 정확하고 최신의 재무 데이터를 기반으로 종목을 선정하도록 개선하였습니다.

---

## 주요 변경 사항

### 1. TTM (최근 4분기 합산) 방식 도입

#### 문제점
- 기존: 연간 재무제표만 사용 (90일 공시 시차)
- 2026년 1월 기준 포트폴리오가 2024년 12월 31일 데이터를 사용하는 문제 발생

#### 해결책
- 분기 재무제표를 활용한 TTM 방식 구현
- 손익계산서/현금흐름표: 최근 4분기 합산 (Flow 항목)
- 재무상태표: 최근 분기 스냅샷 (Stock 항목)
- 공시 시차: 45일 (분기), 90일 (연간)

#### 변경 파일
- `fnguide_crawler.py`: `extract_magic_formula_data()` 함수에 `use_ttm` 파라미터 추가
- `create_current_portfolio.py`: TTM 방식 활성화

#### 코드 변경 (fnguide_crawler.py)
```python
def extract_magic_formula_data(fs_dict, base_date=None, use_ttm=True):
    # 손익계산서/현금흐름표 항목 (4분기 합산 대상)
    flow_accounts = [
        '당기순이익', '법인세비용', '세전계속사업이익',
        '매출액', '매출총이익', '영업이익',
        '영업활동으로인한현금흐름', '감가상각비'
    ]

    # 재무상태표 항목 (최근 분기 값 사용 - 스냅샷)
    stock_accounts = [
        '자산', '부채', '유동부채', '유동자산', '비유동자산',
        '현금및현금성자산', '자본'
    ]
```

---

### 2. 자본잠식 종목 필터 추가

#### 문제점
- 자본잠식 종목(자본 <= 0)이 PBR 계산 시 이상치 발생
- 전략 B에서 넥스트칩, DXVX 등 자본잠식 종목이 상위권에 선정되는 문제

#### 해결책
- `자본 <= 0` 인 종목 자동 제외
- 재무 건전성이 확보된 종목만 선정

#### 변경 파일
- `create_current_portfolio.py`: 자본잠식 필터 추가

#### 코드 변경
```python
# 자본잠식 종목 필터링 (자본 <= 0 제외)
if '자본' in magic_df.columns:
    before_count = len(magic_df)
    magic_df = magic_df[magic_df['자본'] > 0].copy()
    filtered_count = before_count - len(magic_df)
    print(f"자본잠식 종목 제외: {filtered_count}개 제외 → {len(magic_df)}개 종목 남음")
```

---

## 최종 포트폴리오 결과 (2026년 1월)

### 기준 정보
- **기준일**: 2026-01-29
- **재무데이터 기준일**: 2025-09-30 (TTM)
- **유니버스**: 668개 종목 (시가총액 1000억+, 거래대금 50억+, 금융/지주사 제외)

### 전략 A - 마법공식 (상위 10종목)

| 순위 | 종목명 | 이익수익률 | ROIC |
|------|--------|-----------|------|
| 1 | 브이티 | 15.6% | 44.9% |
| 2 | 제닉 | 13.0% | 54.0% |
| 3 | 티앤엘 | 13.8% | 29.9% |
| 4 | 휴메딕스 | 15.4% | 26.5% |
| 5 | F&F | 14.8% | 25.6% |
| 6 | 제룡전기 | 10.7% | 33.3% |
| 7 | SOOP | 11.5% | 27.8% |
| 8 | JYP Ent. | 8.8% | 38.2% |
| 9 | SK스퀘어 | 10.3% | 28.1% |
| 10 | 크래프톤 | 12.5% | 21.3% |

### 전략 B - 멀티팩터 (상위 10종목)

| 순위 | 종목명 | 밸류점수 | 퀄리티점수 |
|------|--------|---------|-----------|
| 1 | 에이피알 | -1.56 | 4.67 |
| 2 | 플리토 | -0.31 | 3.07 |
| 3 | 달바글로벌 | -0.44 | 3.09 |
| 4 | 감성코퍼레이션 | 0.23 | 2.31 |
| 5 | 한화비전 | 2.42 | 0.05 |
| 6 | 글로벌텍스프리 | 0.37 | 1.95 |
| 7 | 카페24 | 0.30 | 2.02 |
| 8 | 데브시스터즈 | 0.34 | 1.95 |
| 9 | 제닉 | 0.29 | 1.92 |
| 10 | 브이티 | 0.34 | 1.86 |

### 공통 종목 (8개)
브이티, 제닉, 티앤엘, 제룡전기, SOOP, 하나투어, 동성화인텍, 글로벌텍스프리

### KOSPI/KOSDAQ 분포
- **전략 A**: KOSPI 10개(33%), KOSDAQ 20개(67%)
- **전략 B**: KOSPI 7개(23%), KOSDAQ 23개(77%)

---

## 캐시 파일 재구축

### 문제
- 기존 캐시 파일 86.6% (1,092개)가 "Repetition level histogram size mismatch" 오류로 손상

### 해결
- 손상된 캐시 파일 전체 삭제
- FnGuide에서 668개 종목 재크롤링 (약 28분 소요)
- 657개 종목 성공적으로 수집

---

## 파일 구조

```
quant_py-main/
├── fnguide_crawler.py          # TTM 로직 추가
├── create_current_portfolio.py # 자본잠식 필터 추가
├── output/
│   ├── portfolio_2026_01_strategy_a.csv
│   ├── portfolio_2026_01_strategy_b.csv
│   └── portfolio_2026_01_report.txt
└── data_cache/
    └── fs_fnguide_*.parquet    # 재무제표 캐시
```

---

## 향후 개선 사항

1. **DART API 통합** (Task #8): FnGuide 크롤링을 DART Open API로 대체
2. **생존 편향 제거** (Task #9): 상장폐지 종목 데이터베이스 구축
3. **섹터 균형 옵션**: KOSPI/KOSDAQ 비율 조정 기능 추가

---

## 작성일
2026-01-30
