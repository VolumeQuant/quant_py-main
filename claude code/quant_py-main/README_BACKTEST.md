# 한국 주식 멀티팩터 전략 백테스팅 시스템

## 📁 프로젝트 구조

```
quant_py-main/
├── data_collector.py          # 데이터 수집 (pykrx)
├── fnguide_crawler.py          # 재무제표 크롤링 (FnGuide)
├── utils.py                    # 유틸리티 함수
├── strategy_a_magic.py         # 전략 A: 마법공식
├── strategy_b_multifactor.py   # 전략 B: 멀티팩터
├── backtest_main.py            # 백테스트 메인 (미완성)
├── run_backtest.py             # 실행 스크립트 ⭐
└── data_cache/                 # 데이터 캐시 폴더
```

## 🚀 빠른 시작

### 1. 필수 패키지 설치

```bash
pip install pandas numpy pykrx FinanceDataReader bt matplotlib seaborn scipy beautifulsoup4 requests tqdm
```

### 2. 테스트 실행

```bash
python run_backtest.py
```

**실행 결과:**
- 대형주 20개 샘플로 전략 테스트
- 전략 A (마법공식) 상위 10종목 출력
- 전략 B (멀티팩터) 상위 10종목 출력
- CSV 파일 저장

**최초 실행 시:**
- FnGuide에서 재무제표 크롤링 (약 2-3분 소요)
- 이후 캐시 사용으로 즉시 로드

## 📊 구현된 전략

### ⭐ 채택된 전략

### 전략 A: 마법공식 (Magic Formula)

**팩터:**
1. **이익수익률** = EBIT / EV
   - EBIT = 당기순이익 + 법인세비용 + 이자비용
   - EV = 시가총액 + 총부채 - 여유자금

2. **투하자본수익률** = EBIT / IC
   - IC = (유동자산 - 유동부채) + (비유동자산 - 감가상각비)

**종목 선정:**
- 두 지표의 순위를 합산
- 순위 합계가 낮은 종목 선택

### 전략 B: 멀티팩터

**팩터:**
- **밸류**: PER↓, PBR↓, PCR↓, PSR↓, 배당수익률↑
- **퀄리티**: ROE↑, GPA↑, CFO↑
- **모멘텀**: 12개월 수익률↑ (최근 1개월 제외)

**종목 선정:**
- 섹터별 Z-Score 계산
- 밸류 + 퀄리티 + 모멘텀 점수 합산
- 상위 종목 선택

---

### ❌ 폐기된 전략

### 전략 C: 코스닥 성장 (KOSDAQ Growth) - 실패 사례

**배경:**
- 정부의 코스닥 3000 정책 발표 (연기금 자금 유입 예상)
- 코스닥 특화 전략 필요성 제기

**팩터:**
- **성장성 (50%)**: 매출성장률, 순이익성장률, 영업이익성장률
- **모멘텀 (30%)**: 6개월/12개월 수익률
- **퀄리티 (20%)**: ROE, 영업이익률
- **제외**: 수급 데이터 (volume-breakout-backtest 검증 결과 무효)

**백테스팅 결과 (2015-2025):**
- CAGR: **-5.33%** (참혹한 실패)
- MDD: **-69.85%** (거의 파산 수준)
- Sharpe: **-0.171** (음수!)
- vs KOSDAQ 150: **-10.35%p** 언더퍼폼

**실패 원인:**
1. 성장률 데이터 부정확 (1년 전 데이터 없어 추정치 사용)
2. 모멘텀 과열 종목 편입 (단기 급등주 → 급락)
3. 코스닥 고변동성 감당 불가
4. 정부 정책에 의존한 나이브한 접근

**교훈:**
- ✅ 정부 정책보다 **펀더멘털이 우선**
- ✅ 데이터 품질이 전략 성패 좌우
- ✅ 코스닥 투자는 **전략 A (60% 코스닥)** 활용

---

## ⚙️ 현재 상태

### ✅ 완료된 부분

1. **데이터 수집**
   - ✅ pykrx: 주가, 시가총액, 기본 펀더멘털
   - ✅ FnGuide: 재무제표 크롤링
   - ✅ 캐싱 시스템

2. **전략 구현**
   - ✅ 마법공식 계산 로직
   - ✅ 멀티팩터 계산 로직
   - ✅ 유니버스 필터링

3. **테스트**
   - ✅ 샘플 종목으로 실행 가능
   - ✅ 결과 CSV 저장

### 🔧 수정 필요 (중요!)

#### 1. 재무제표 계정명 매핑

FnGuide의 **실제 계정명**을 확인하여 `fnguide_crawler.py`의 `account_mapping` 수정 필요:

```python
# fnguide_crawler.py 107번째 줄
account_mapping = {
    '당기순이익': '당기순이익',  # ← 실제 계정명 확인
    '법인세비용': '법인세비용',  # ← 실제 계정명 확인
    # ...
}
```

**확인 방법:**
```python
python fnguide_crawler.py  # 테스트 실행
# → "계정 목록 (일부)" 출력에서 실제 계정명 확인
```

예상 계정명:
- `법인세비용` → `법인세차감전순이익` + `법인세비용`으로 분리될 수 있음
- `이자비용` → `금융비용`으로 표시될 수 있음

#### 2. 주가 데이터 수집 (백테스트용)

현재 `run_backtest.py`는 **정적 포트폴리오만 생성**합니다.

**전체 백테스트 실행을 위해 필요:**
```python
# 전체 기간 주가 데이터 수집 (2015-2025)
collector = DataCollector('20150101', '20251231')
price_data = collector.get_all_ohlcv(all_tickers)
```

⚠️ **주의:** 전체 종목(약 2,000개) × 10년 = 매우 오래 걸림
→ **우선 대형주 100개로 테스트 권장**

#### 3. 리밸런싱 백테스트

`backtest_main.py`에 동적 리밸런싱 로직 추가 필요:
- 분기별(3, 6, 9, 12월 말) 종목 재선정
- bt 패키지의 `WeighTarget` 또는 커스텀 알고리즘

## 🎯 다음 단계 (우선순위)

### 단계 1: 재무제표 계정명 확인 ⭐

```bash
python fnguide_crawler.py
```

출력된 계정명을 보고 `account_mapping` 수정

### 단계 2: 샘플 확장 테스트

`run_backtest.py`의 `sample_tickers`를 100개로 확장:

```python
# KRX 시가총액 상위 100개 가져오기
market_cap_df = collector.get_market_cap('20241231', 'ALL')
top_100 = market_cap_df.nlargest(100, '시가총액').index.tolist()
```

### 단계 3: 주가 데이터 수집

```python
price_data = collector.get_all_ohlcv(top_100, '20150101', '20251231')
```

### 단계 4: bt 패키지로 백테스트

`backtest_main.py` 완성:
- 리밸런싱 날짜마다 전략 실행
- 거래비용 반영
- 성과 지표 계산

### 단계 5: 시각화

- 누적수익률 차트
- IS/OOS 구분
- Drawdown 차트
- 성과 테이블

## 🐛 문제 해결

### 문제 1: FnGuide 크롤링 오류

**증상:** `pd.read_html()` 실패

**원인:**
- 네트워크 문제
- FnGuide 서버 부하
- 존재하지 않는 종목코드

**해결:**
- 캐시가 있으면 `use_cache=True` 사용
- `time.sleep(2)` 늘리기
- 오류 종목 건너뛰기

### 문제 2: 계정명 불일치

**증상:** `KeyError` 또는 `NaN` 값

**원인:** FnGuide 계정명이 코드와 다름

**해결:**
1. `python fnguide_crawler.py` 실행
2. 출력된 계정명 확인
3. `account_mapping` 수정

### 문제 3: 메모리 부족

**증상:** 전체 종목 크롤링 시 메모리 오류

**해결:**
- 배치 처리 (100개씩)
- 캐시 활용
- 필요한 종목만 선택

## 📝 데이터 소스

- **주가, 시가총액**: pykrx (KRX 공식)
- **재무제표**: FnGuide Company Guide (크롤링)
- **벤치마크**: 코스피 지수 (pykrx)

## ⚖️ 법적 고려사항

**FnGuide 크롤링:**
- 개인 연구/학습 목적으로 제한적 사용
- 상업적 목적 사용 금지
- 과도한 크롤링 자제 (서버 부하)
- 가능하면 유료 API 사용 권장

**대안:**
- DART Open API (무료, 공식)
- QuantQuant, WiseFn 등 유료 서비스

## 💡 팁

1. **캐시 활용**: 재무제표는 자주 바뀌지 않으므로 캐시 적극 활용
2. **배치 처리**: 전체 종목 대신 우선 100개로 테스트
3. **오류 처리**: 일부 종목 실패해도 계속 진행
4. **결과 저장**: CSV로 중간 결과 저장하여 분석

## 📞 문의

- GitHub Issues
- 기존 책 "파이썬을 이용한 퀀트 투자 포트폴리오 만들기" 참고

---

**작성일:** 2026-01-29
**버전:** 1.0 (프로토타입)
